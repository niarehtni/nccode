package nc.impl.hrpub.dataexchange.businessprocess;

import java.util.HashMap;
import java.util.Map;
import java.util.Map.Entry;

import nc.bs.framework.common.NCLocator;
import nc.impl.hrpub.dataexchange.DataImportExecutor;
import nc.impl.trn.dimissionrds.DimissionrdsServiceImpl;
import nc.itf.hi.IPsndocQryService;
import nc.itf.hrpub.IDataExchangeExternalExecutor;
import nc.itf.trn.rds.IRdsManageService;
import nc.vo.hi.psndoc.PsnJobVO;
import nc.vo.hi.psndoc.PsndocAggVO;
import nc.vo.hi.psndoc.PsndocVO;
import nc.vo.pub.BusinessException;
import nc.vo.pub.lang.UFBoolean;
import nc.vo.pub.lang.UFDateTime;
import nc.vo.pub.lang.UFLiteralDate;

import org.apache.commons.lang.StringUtils;

public class PsnjobBPImportExecutor extends DataImportExecutor implements
		IDataExchangeExternalExecutor {

	private Map<String, PsndocAggVO> rowNCVO;
	private Map<String, String> rowPsnTypeMap;

	public PsnjobBPImportExecutor() throws BusinessException {
		super();
	}

	@Override
	public Object getBizEntityID() throws BusinessException {
		// 必x值，否t不加d本型
		// wIDmd_class的ID谖
		// md_class.name = hi_psnjob
		// 不定x返回ID，BP模式不m用
		// return "7156d223-4531-4337-b192-492ab40098f1";
		return null;
	}

	@Override
	public void beforeUpdate() throws BusinessException {
		if (this.getNcValueObjects() != null
				&& this.getNcValueObjects().size() > 0) {
			String rowNo = "";
			for (Map<String, Object> rowNCMap : this.getNcValueObjects()) {
				try {
					rowNo = rowNCMap.keySet().toArray(new String[0])[0]
							.split(":")[0];

					String pk_psndoc = (String) rowNCMap.get(rowNo
							+ ":pk_psndoc");

					PsndocAggVO aggVO = this.getMDQueryService()
							.queryPsndocVOByPk(pk_psndoc);

					PsndocVO psndocVO = aggVO.getParentVO();

					PsnJobVO psnjobVO = new PsnJobVO();
					psnjobVO.setAssgid(psndocVO.getPsnJobVO().getAssgid());
					psnjobVO.setBegindate(new UFLiteralDate((String) rowNCMap
							.get(rowNo + ":begindate")));
					psnjobVO.setClerkcode(psndocVO.getCode());
					psnjobVO.setCreationtime(new UFDateTime((String) rowNCMap
							.get(rowNo + ":creationtime")));
					psnjobVO.setCreator((String) rowNCMap.get(rowNo
							+ ":creator"));
					psnjobVO.setDr(0);
					if (!StringUtils.isEmpty((String) rowNCMap.get(rowNo
							+ ":enddate"))) {
						psnjobVO.setEnddate(new UFLiteralDate((String) rowNCMap
								.get(rowNo + ":enddate")));
					}
					psnjobVO.setEndflag(UFBoolean.FALSE);
					psnjobVO.setLastflag(UFBoolean.TRUE);
					psnjobVO.setIsmainjob(UFBoolean.TRUE);
					psnjobVO.setAttributeValue("jobglbdef1",
							rowNCMap.get(rowNo + ":jobglbdef1"));
					psnjobVO.setAttributeValue("jobglbdef4",
							rowNCMap.get(rowNo + ":jobglbdef4"));
					psnjobVO.setAttributeValue("jobglbdef5",
							rowNCMap.get(rowNo + ":jobglbdef5"));
					psnjobVO.setAttributeValue("jobglbdef8",
							rowNCMap.get(rowNo + ":jobglbdef8"));
					psnjobVO.setMemo((String) rowNCMap.get(rowNo + ":memo"));
					psnjobVO.setPk_dept((String) rowNCMap.get(rowNo
							+ ":pk_dept"));
					psnjobVO.setPk_group(this.getPk_group());
					psnjobVO.setPk_hrgroup(this.getPk_group());
					psnjobVO.setPk_hrorg(psndocVO.getPsnJobVO().getPk_hrorg());
					psnjobVO.setPk_org(psndocVO.getPsnJobVO().getPk_org());
					psnjobVO.setPk_jobrank((String) rowNCMap.get(rowNo
							+ ":pk_jobrank"));
					psnjobVO.setPk_psncl(psndocVO.getPsnJobVO().getPk_psncl());
					psnjobVO.setPk_psnorg(psndocVO.getPsnJobVO().getPk_psnorg());
					psnjobVO.setPoststat(UFBoolean.TRUE);
					psnjobVO.setRecordnum(0);
					psnjobVO.setShoworder(9999999);
					psnjobVO.setTrial_flag(UFBoolean.FALSE);
					psnjobVO.setTs(new UFDateTime());
					psnjobVO.setPk_psndoc((String) rowNCMap.get(rowNo
							+ ":pk_psndoc"));
					psnjobVO.setPsntype(Integer.valueOf((String) rowNCMap
							.get(rowNo + ":psntype")));
					psnjobVO.setSeries((String) rowNCMap.get(rowNo + ":series"));
					psnjobVO.setTrnsreason((String) rowNCMap.get(rowNo
							+ ":trnsreason"));
					psnjobVO.setTrnstype((String) rowNCMap.get(rowNo
							+ ":trnstype"));

					aggVO.setTableVO(PsnJobVO.getDefaultTableName(),
							new PsnJobVO[] { psnjobVO });

					this.getRowNCVO().put(rowNo, aggVO);
				} catch (Exception e) {
					this.getErrorMessages().put(rowNo, e.getMessage());
				}
			}
		}
	}

	private String getPk_psncl(String psnclCode) throws BusinessException {
		String key = getCacheKey("PSNCL", "NULL", psnclCode);
		String strSQL = "select pk_psncl from bd_psncl where code="
				+ getStringValue(psnclCode);
		return getKeyValue(key, strSQL);
	}

	@Override
	public void afterUpdate() throws BusinessException {
		// TODO 自动生成的方法存根

	}

	@Override
	public void afterConvert() throws BusinessException {
		// TODO 自动生成的方法存根

	}

	@Override
	public void beforeConvert() throws BusinessException {
		if (this.getJsonValueObjects() != null
				&& this.getJsonValueObjects().size() > 0) {
			for (Map<String, Object> jsonobj : this.getJsonValueObjects()) {
				String rowNo = "";
				String psntype = "";
				for (Entry<String, Object> entry : jsonobj.entrySet()) {
					if (entry.getKey().contains("ROWNO")) {
						rowNo = (String) entry.getValue();
					} else if (entry.getKey().contains("NPEONO")) {
						psntype = (String) entry.getValue();
					}
				}

				this.getRowPsnTypeMap().put(rowNo, psntype);
			}
		}
	}

	@Override
	public void beforeQuery() throws BusinessException {
		// TODO 自动生成的方法存根

	}

	@Override
	public void afterQuery() throws BusinessException {
		// TODO 自动生成的方法存根

	}

	@Override
	public void beforeInsertOperation(Map<String, Object> rowMap)
			throws BusinessException {
		// TODO 自动生成的方法存根

	}

	@Override
	public void beforeUpdateOperation(Map<String, Object> rowMap)
			throws BusinessException {
		// TODO 自动生成的方法存根

	}

	@Override
	public void doUpdateByBP() throws BusinessException {
		if (rowNCVO != null && rowNCVO.size() > 0) {
			for (Entry<String, PsndocAggVO> rowData : rowNCVO.entrySet()) {
				try {
					this.getVOSaveService().addPsnjob(rowData.getValue(),
							"hi_psnjob", true, this.getPk_org());
				} catch (BusinessException e) {
					this.getErrorMessages().put(rowData.getKey(),
							e.getMessage());
				}
			}
		}
	}

	private IRdsManageService getVOSaveService() {
		return new DimissionrdsServiceImpl();
	}

	private IPsndocQryService getMDQueryService() {
		return (IPsndocQryService) NCLocator.getInstance().lookup(
				IPsndocQryService.class);
	}

	public Map<String, PsndocAggVO> getRowNCVO() {
		if (rowNCVO == null) {
			rowNCVO = new HashMap<String, PsndocAggVO>();
		}
		return rowNCVO;
	}

	public void setRowNCVO(Map<String, PsndocAggVO> rowNCVO) {
		this.rowNCVO = rowNCVO;
	}

	public Map<String, String> getRowPsnTypeMap() {
		if (rowPsnTypeMap == null) {
			rowPsnTypeMap = new HashMap<String, String>();
		}
		return rowPsnTypeMap;
	}

	public void setRowPsnTypeMap(Map<String, String> rowPsnTypeMap) {
		this.rowPsnTypeMap = rowPsnTypeMap;
	}

}
