package nc.impl.twhr;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import nc.bs.dao.BaseDAO;
import nc.bs.dao.DAOException;
import nc.bs.framework.common.NCLocator;
import nc.hr.utils.InSQLCreator;
import nc.impl.pub.ace.AceTwhr_declarationPubServiceImpl;
import nc.itf.twhr.ITwhr_declarationMaintain;
import nc.itf.uap.IUAPQueryBS;
import nc.jdbc.framework.processor.BeanListProcessor;
import nc.jdbc.framework.processor.ColumnListProcessor;
import nc.jdbc.framework.processor.MapListProcessor;
import nc.pubitf.para.DeclarationUtils;
import nc.pubitf.para.SysInitQuery4TWHR;
import nc.pubitf.twhr.utils.LegalOrgUtilsEX;
import nc.ui.querytemplate.querytree.IQueryScheme;
import nc.vo.hi.psndoc.PTCostVO;
import nc.vo.logging.Debug;
import nc.vo.pub.BusinessException;
import nc.vo.pub.ISuperVO;
import nc.vo.pub.SuperVO;
import nc.vo.pub.VOStatus;
import nc.vo.pub.lang.UFDate;
import nc.vo.pub.lang.UFDateTime;
import nc.vo.pub.lang.UFDouble;
import nc.vo.pub.lang.UFLiteralDate;
import nc.vo.twhr.nhicalc.PsndocDefTableUtil;
import nc.vo.twhr.twhr_declaration.AggDeclarationVO;
import nc.vo.twhr.twhr_declaration.BusinessBVO;
import nc.vo.twhr.twhr_declaration.CompanyBVO;
import nc.vo.twhr.twhr_declaration.NonPartTimeBVO;
import nc.vo.twhr.twhr_declaration.PartTimeBVO;
import nc.vo.wa.paydata.DataVO;

public class Twhr_declarationMaintainImpl extends AceTwhr_declarationPubServiceImpl
		implements ITwhr_declarationMaintain {

	private BaseDAO basDAO;
	// 申报格式:50薪资:1 90AB:2 其他:0
	private static final int DECLAREFORM_50 = 1;
	private static final int DECLAREFORM_90AB = 2;
	private static final int DECLAREFORM_OTHER = 0;
	//非兼职人员表名
	private static String DECLARATION_NONPARTTIME_TABLE_NAME = "declaration_nonparttime";
	//兼职人员表名
	private static String DECLARATION_PARTTIME_TABLE_NAME = "declaration_parttime";
	//执行业务所得表名
	private static String DECLARATION_BUSINESS_TABLE_NAME = "declaration_business";
	//公司补充保费表名
	private static String DECLARATION_COMPANY_TABLE_NAME = "declaration_company";
	/**
	 * @return the basDAO
	 */
	private BaseDAO getBaseDAO() {
		if(null == basDAO){
			basDAO = new BaseDAO();
		}
		return basDAO;
	}
	//薪资发放数据map<薪资方案,map<薪资期间,map<人员,本次扣税金额>>>
	private Map<String,Map<String,Map<String,Double>>> payMap = new HashMap<>();


	@Override
	public void delete(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		super.pubdeleteBills(clientFullVOs, originBills);
	}

	@Override
	public AggDeclarationVO[] insert(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		return super.pubinsertBills(clientFullVOs, originBills);
	}

	@Override
	public AggDeclarationVO[] update(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		return super.pubupdateBills(clientFullVOs, originBills);
	}

	@Override
	public AggDeclarationVO[] query(IQueryScheme queryScheme)
			throws BusinessException {
		return super.pubquerybills(queryScheme);
	}

	@Override
	public AggDeclarationVO[] save(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		return super.pubsendapprovebills(clientFullVOs, originBills);
	}

	@Override
	public AggDeclarationVO[] unsave(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		return super.pubunsendapprovebills(clientFullVOs, originBills);
	}

	@Override
	public AggDeclarationVO[] approve(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		return super.pubapprovebills(clientFullVOs, originBills);
	}

	@Override
	public AggDeclarationVO[] unapprove(AggDeclarationVO[] clientFullVOs,
			AggDeclarationVO[] originBills) throws BusinessException {
		return super.pubunapprovebills(clientFullVOs, originBills);
	}

	/* (non-Javadoc)
	 * @see nc.itf.twhr.ITwhr_declarationMaintain#writeBack4HealthCaculate(nc.vo.twhr.twhr_declaration.AggDeclarationVO[], nc.vo.twhr.twhr_declaration.AggDeclarationVO[])
	 */
	@Override
	public void writeBack4HealthCaculate(AggDeclarationVO originBill)
			throws BusinessException {
		if(null == originBill){
			return;
		}
		ISuperVO[] partTimeBVOs = originBill.getChildren(PartTimeBVO.class);
		//生成序号
		if(null != partTimeBVOs){
			int count0 = generaRowNum(DECLARATION_PARTTIME_TABLE_NAME);
			for(ISuperVO vo : partTimeBVOs){
				PartTimeBVO pvo = (PartTimeBVO)vo;
				pvo.setNum(++count0);
			}
		}
		ISuperVO[] nonPartTimeBVOs = originBill.getChildren(NonPartTimeBVO.class);
		//生成序号
		if(null != nonPartTimeBVOs){
			int count1 = generaRowNum(DECLARATION_NONPARTTIME_TABLE_NAME);
			for(ISuperVO vo : nonPartTimeBVOs){
				NonPartTimeBVO pvo = (NonPartTimeBVO)vo;
				pvo.setNum(++count1);
			}
		}
		ISuperVO[] businessBVOs = originBill.getChildren(BusinessBVO.class);
		//生成序号
		if(null != businessBVOs){
			int count2 = generaRowNum(DECLARATION_BUSINESS_TABLE_NAME);
			for(ISuperVO vo : businessBVOs){
				BusinessBVO pvo = (BusinessBVO)vo;
				pvo.setNum(++count2);
			}
		}

		AggDeclarationVO [] saveVOs = {originBill};
		//先当成新增全新的记录
		insert(saveVOs,saveVOs);
		//根据组织查找主键,并fix
		dataFix(originBill.getParentVO().getPk_org());

	}
	/**
	 * 生成序号
	 * 给后人:有个大仙把num设成了int,如果溢出了,元数据字段类型改大一点~
	 * @return
	 * @author Ares.Tank
	 * @param class1
	 * @date 2018年10月8日 下午5:19:39
	 * @description
	 */
	private int generaRowNum(String tableName){
		if(null == tableName){
			return 0;
		}
		String sqlStr = "select max(num) as countsum from " + tableName;
		Integer sum = 0;
		List objs = null;
		try {
			objs = (List) getBaseDAO().executeQuery(sqlStr, new ColumnListProcessor());
		} catch (DAOException e) {
			e.printStackTrace();
		}
		if (null != objs) {
			for (Object obj : objs) {
				if (null != obj) {
					sum = (Integer) obj;
				}
			}
		}
		return sum;
	}
	/**
	 * 把所有字表的记录都设置成唯一一条主表的记录
	 *(此界面没有主表,但是四个字表,通过一条默认数据来关连个子表)
	 * @throws BusinessException
	 * @author Ares.Tank
	 * @date 2018年9月25日 下午4:05:42
	 * @description
	 */
	private void dataFix(String pk_org) throws BusinessException{
		//根据组织查找主键
		String sqlStr ="select pk_declaration from twhr_declaration "
				+ "where twhr_declaration.pk_org = '"+pk_org+"' and dr = 0";
		String keyOfDeclaration = null;
		List pk_declarations
			= (List)getBaseDAO().executeQuery(sqlStr, new ColumnListProcessor());
		if(null==pk_declarations){
			//新组织就直接存
			return ;
		}else{
			for(Object obj : pk_declarations){
				if(null==obj){
					return ;
				}
				keyOfDeclaration = obj.toString();

			}
		}

		sqlStr = "update declaration_parttime SET rowno = null,pk_declaration = '"+keyOfDeclaration+"' "
				+ " where pk_org = '"+pk_org+"' and dr = 0";
		getBaseDAO().executeUpdate(sqlStr);

		sqlStr = "update declaration_nonparttime SET rowno = null,pk_declaration = '"+keyOfDeclaration+"'"
				+ " where pk_org = '"+pk_org+"' and dr = 0";
		getBaseDAO().executeUpdate(sqlStr);

		sqlStr = "update declaration_business SET rowno = null,pk_declaration = '"+keyOfDeclaration+"'"
				+ " where pk_org = '"+pk_org+"' and dr = 0";
		getBaseDAO().executeUpdate(sqlStr);

		sqlStr = "update declaration_company SET rowno = null,pk_declaration = '"+keyOfDeclaration+"'"
				+ " where pk_org = '"+pk_org+"' and dr = 0";
		getBaseDAO().executeUpdate(sqlStr);

		//删除旧引用
		sqlStr = "delete from twhr_declaration "
				+ " where (pk_declaration <> '"+keyOfDeclaration+"' or dr = null) "
				+ "and pk_org = '"+pk_org+"'";
		getBaseDAO().executeUpdate(sqlStr);

	}



	/* (non-Javadoc)
	 * @see nc.itf.twhr.ITwhr_declarationMaintain#generatCompanyBVO(nc.vo.pub.lang.UFDate)
	 */
	@Override
	public void generatCompanyBVO(UFDate dateMonth,String pk_hrorg,String pkGroup) throws BusinessException {
		Set<String> orgs = LegalOrgUtilsEX.getOrgsByLegal(pk_hrorg, pkGroup);
		//年份
		String cyear = dateMonth.getYear() + "";
		//月份
		String cperiod = dateMonth.getStrMonth();
		
		for (String pk_org : orgs) {
			UFDouble heathRate = SysInitQuery4TWHR.getParaDbl(pk_org,
					"TWEP0002");
			if (null == heathRate) {
				throw new BusinessException(
						"o法找到a充保UM率(雇主)O置，z查自定x(TWEP0002)的O定热荨");
			}
			// 查出日期符合的非兼职人员信息
			List<CompanyBVO> saveList = new ArrayList<>();
			AggDeclarationVO avo = DeclarationUtils.getAggDeclarationVO();
			avo.getParentVO().setPk_group(pkGroup);
			avo.getParentVO().setPk_org(pk_org);
			// 找出公司补充保费的总条数
			String sqlStr = "select max(num) as countsum from declaration_company ";
			Integer sum = 0;
			List objs = (List) getBaseDAO().executeQuery(sqlStr, new ColumnListProcessor());
			if (null != objs) {
				for (Object obj : objs) {
					if (null != obj) {
						sum = (Integer) obj;
					}
				}
			}
			//月初时间
			String startDayOfMonth = getStartDay(dateMonth);
			//下月初时间
			String endDayOfMonth = getEndDay(dateMonth);
			//删除该组织该月的记录
			sqlStr = " delete from declaration_company "
			+ " where pay_date >= '"+startDayOfMonth+"' "
			+ " and pay_date < '"+endDayOfMonth+"' "
			+ "and vbdef1 = '"+pk_org+"' and dr = 0 ";
			getBaseDAO().executeUpdate(sqlStr);
			if (sum == null || sum < 0) {
				sum = 0;
			}
			sqlStr = "SELECT dnp.* from declaration_nonparttime dnp "
					+ " LEFT JOIN twhr_declaration dectw on dnp.pk_declaration = dectw.pk_declaration "
					+ " where dnp.pay_date >= '" + startDayOfMonth + "' and dnp.pay_date < '"
					+ endDayOfMonth + "' " + " and dnp.pk_org = '" + pk_org + "'";
			List<NonPartTimeBVO> resultBeans = (List<NonPartTimeBVO>) getBaseDAO().executeQuery(sqlStr,
					new BeanListProcessor(NonPartTimeBVO.class));
			if (null != resultBeans) {
				for (NonPartTimeBVO vo : resultBeans) {
					if (null == vo) {
						continue;
					}
					CompanyBVO newVO = new CompanyBVO();
					// 行号
					newVO.setNum(++sum);
					// 部门
					newVO.setPk_dept(vo.getPk_dept());
					// 薪资方案
					newVO.setPk_wa_class(vo.getVbdef2());
					// 给付日期
					newVO.setPay_date(vo.getPay_date());
					// 给付金额(本次扣基)
					newVO.setPay_money(getPay(vo.getVbdef4(),vo.getVbdef2(),cyear,cperiod));
					// 人员
					newVO.setPk_psndoc(vo.getVbdef4());
					// 投保总额 (级距)
					newVO.setTotalinsure(vo.getDeductions_month_insure());
					// a充保MM基
					newVO.setReplenis_base(vo.getSingle_pay().sub(newVO.getTotalinsure()));
					// 补充保费 
					newVO.setCompany_bear(newVO.getReplenis_base().multiply(heathRate).div(100));
					// TS
					newVO.setTs(new UFDateTime());
					//法人组织
					newVO.setVbdef1(vo.getVbdef1());
					//薪资方案
					newVO.setVbdef2(vo.getVbdef2());
					//薪资期间
					newVO.setVbdef3(vo.getVbdef3());
					//人员
					newVO.setVbdef4(vo.getVbdef4());

					saveList.add(newVO);
				}
			}
			// 查出日期符合的兼职人员的信息
			sqlStr = "SELECT dnp.* from declaration_parttime dnp "
					+ " LEFT JOIN twhr_declaration dectw on dnp.pk_declaration = dectw.pk_declaration "
					+ " where dnp.pay_date >= '" + startDayOfMonth + "' and dnp.pay_date < '"
					+ endDayOfMonth + "' " + " and dectw.pk_org = '" + pk_org + "'";
			List<PartTimeBVO> qryResultBeans = (List<PartTimeBVO>) getBaseDAO().executeQuery(sqlStr,
					new BeanListProcessor(PartTimeBVO.class));
			if (null != qryResultBeans) {
				for (PartTimeBVO vo : qryResultBeans) {
					if (null == vo) {
						continue;
					}
					CompanyBVO newVO = new CompanyBVO();
					// 行号
					newVO.setNum(++sum);
					// 部门
					newVO.setPk_dept(vo.getPk_dept());
					// 薪资方案
					newVO.setPk_wa_class(vo.getVbdef2());
					// 给付日期
					newVO.setPay_date(vo.getPay_date());
					// 给付金额(本次扣基)
					newVO.setPay_money(getPay(vo.getVbdef4(),vo.getVbdef2(),cyear,cperiod));
					// 人员
					newVO.setPk_psndoc(vo.getVbdef4());
					// 投保总额 (级距)--兼职人员有投保级距
					newVO.setTotalinsure(getPsndocGrande(vo.getVbdef4(),vo.getPay_date()));
					// a充保MM基--兼职人员费基 
					newVO.setReplenis_base(vo.getSingle_pay().sub(newVO.getTotalinsure()));
					// 补充保费
					newVO.setCompany_bear(newVO.getReplenis_base().multiply(heathRate).div(100));
					// TS
					newVO.setTs(new UFDateTime());
					//法人组织
					newVO.setVbdef1(vo.getVbdef1());
					//薪资方案
					newVO.setVbdef2(vo.getVbdef2());
					//薪资期间
					newVO.setVbdef3(vo.getVbdef3());
					//人员
					newVO.setVbdef4(vo.getVbdef4());

					saveList.add(newVO);
				}
			}
			if(pk_org.equals(pk_hrorg)){
				//从劳务费用节点抓取 50薪资的数据
				sqlStr = "select * from hi_psndoc_ptcost "
						+ " left join bd_psndoc on bd_psndoc.pk_psndoc = hi_psndoc_ptcost.pk_psndoc "
						+ " where declareformat = (select top 1 pk_defdoc "
						+ " from bd_defdoc where pk_defdoclist = '1001ZZ1000000001NEF9' and code = '50') "
						+ " and paydate >= '"+startDayOfMonth+"' and paydate < '"+endDayOfMonth+"' "
						+ " and bd_psndoc.pk_org = '"+pk_org+"'";
				List<PTCostVO> qResult = 
						(List<PTCostVO>)getDao().executeQuery(sqlStr, new BeanListProcessor(PTCostVO.class));
				if (null != qryResultBeans) {
					for (PTCostVO vo : qResult) {
						if (null == vo) {
							continue;
						}
						CompanyBVO newVO = new CompanyBVO();
						// 行号
						newVO.setNum(++sum);
						// 部门
						newVO.setPk_dept(null);
						// 薪资方案
						newVO.setPk_wa_class(null);
						// 给付日期
						newVO.setPay_date(new UFDate(vo.getPaydate().toDate()));
						// 给付金额(本次扣基)
						newVO.setPay_money(vo.getPayamount());
						// 人员
						newVO.setPk_psndoc(vo.getPk_psndoc());
						// 投保总额 (级距)--兼职人员有投保级距
						newVO.setTotalinsure(getPsndocGrande(newVO.getPk_psndoc(),newVO.getPay_date()));
						// a充保MM基--兼职人员费基 
						newVO.setReplenis_base(newVO.getPay_money().sub(newVO.getTotalinsure()));
						// 补充保费
						newVO.setCompany_bear(newVO.getReplenis_base().multiply(heathRate).div(100));
						// TS
						newVO.setTs(new UFDateTime());
						//法人组织
						newVO.setVbdef1(pk_org);
						//薪资方案
						newVO.setVbdef2(null);
						//薪资期间
						newVO.setVbdef3(null);
						//人员
						newVO.setVbdef4(vo.getPk_psndoc());

						saveList.add(newVO);
					}
				}
			}
			
			//处理入月投保闳胂缕谟算
			saveList = deal2NextMonth(saveList);
			avo.setChildren(CompanyBVO.class, saveList.toArray(new CompanyBVO[0]));
			AggDeclarationVO[] saveVOs = { avo };
			// 先当成新增全新的记录
			insert(saveVOs, saveVOs);
			// 根据组织查找主键,并fix
			dataFix(avo.getParentVO().getPk_org());
		}
	}
	/**
	 * 处理入月投保闳胂缕谟算
	 * T工YSo上新增入月投保闳胂缕谟算的值谖唬
	 * 生成公司a充保Mr，如果勾x後，系yz查T工的M入日期，健保投保型B榧颖＃
	 * 健保_始日期c入日期橥一月份，ty公司a充保Mr，
	 * T工的投保~0，若投保o榧颖K且健保_始日期樯显拢tT工的投保~樯显路+本月份距  
	 * @param saveList
	 * @return
	 * @throws BusinessException 
	 */
	private List<CompanyBVO> deal2NextMonth(List<CompanyBVO> saveList) throws BusinessException {
		for(CompanyBVO vo : saveList){
			if(vo!=null && vo.getVbdef4() != null && vo.getPay_date()!=null){
				String pk_psndoc = vo.getVbdef14();
				//本月日期
				String thismonth = vo.getPay_date().toStdString();
				Calendar cal = Calendar.getInstance();
				cal.setTime(vo.getPay_date().toDate());
				cal.add(Calendar.MONTH, -1);
				//一个月前
				String lastmonth = new UFDate(cal.getTime()).toStdString();
				//从这些人员中找出需要'入月投保闳胂缕谟算'的人员
				/**1.'入月投保闳胂缕谟算'打勾的
				*2.健保投保型B榧颖, */
				//读取人员的入职日期,健保开始日期,上月健保级距,本月健保级距
		        String sqlStr = " select psn.pk_psndoc psndoc,psnorg.begindate enterdate ,g2.begindate healthbegindate, "
		        				+ " SALARY_DECRYPT(nvl(g2last.glbdef16,0)) lastgrade , "
		        				+ " SALARY_DECRYPT(nvl(g2.glbdef16,0)) thisgrade "
		        				+ " from hi_psndoc_glbdef2 g2 "
		        				+ " left join bd_psndoc psn on g2.pk_psndoc = psn.pk_psndoc "
		        				+ " left join hi_psndoc_glbdef2 g2last on "
		        				+ " (g2last.pk_psndoc = psn.pk_psndoc and g2last.insuranceform = 1 and g2last.dr = 0 "
		        				+ " and  g2last.begindate <= '"+lastmonth+"' "
		        				+ " and nvl(g2last.enddate,'9999-12-01') >= '"+lastmonth+"' "
		        				+ " and g2last.glbdef2 = '本人') "
		        				+ " left join hi_psnorg psnorg on (psnorg.pk_psndoc = psn.pk_psndoc and psnorg.dr = 0 "
		        				+ " and psnorg.begindate <= '"+thismonth+"' "
		        				+ " and nvl(psnorg.enddate,'9999-12-31') >='"+thismonth+"' ) "
		        				+ " where psn.istonextmonth = 'Y' "
		        				+ " and g2.insuranceform = 1 "
		        				+ " and psn.dr = 0 and g2.dr = 0 "
		        				+ " and  g2.begindate <= '"+thismonth+"' "
		        				+ " and nvl(g2.enddate,'9999-12-31') >= '"+thismonth+"' "
		        				+ " and g2.glbdef2 = '本人' "
		        				+ " and g2.pk_psndoc = '"+pk_psndoc+"' ";
		        List<Map<String,Object>> qResult = 
		        		(List<Map<String,Object>>)getDao().executeQuery(sqlStr, new MapListProcessor());
		        if(qResult != null && qResult.size() > 0){
		        	for(Map<String,Object> colMap : qResult){
		        		if(null==colMap){
		        			continue;
		        		}
		        		//入职日期
		        		String enterdateStr = String.valueOf(colMap.get("enterdate"));
		        		//健保开始日期
		        		String healthbegindateStr = String.valueOf(colMap.get("healthbegindate"));
		        		//上月级距
		        		String lastgradeStr = String.valueOf(colMap.get("lastgrade"));
		        		//本月级距
		        		String thisgradeStr = String.valueOf(colMap.get("thisgrade"));
		        		//入职日期
	        			UFLiteralDate enterDate = null;
	        			//健保开始日期
	        			UFLiteralDate healthBeginDate = null;
	        			//上月级距
	        			UFDouble lastGrade = null;
	        			//本月级距
	        			UFDouble thisgrade = null;
		        		try{
		        			//入职日期
		        			 enterDate = new UFLiteralDate(enterdateStr);
		        			//健保开始日期
		        			 healthBeginDate = new UFLiteralDate(healthbegindateStr);
		        			//上月级距
		        			 lastGrade = new UFDouble(lastgradeStr);
		        			//本月级距
		        			 thisgrade = new UFDouble(thisgradeStr);
		        		}catch(Exception e){
		        			throw new BusinessException(e.getMessage());
		        		}
		        		if(null == enterDate || null == healthBeginDate || null == lastGrade || null == thisgrade){
		        			continue;
		        		}
		        		//若健保_始日期c入日期橥一月份且都为本月(paydate月)->投保总额为0
		        		if(enterDate.getMonth()==healthBeginDate.getMonth()
		        				&& enterDate.getMonth() == vo.getPay_date().getMonth()){
		        			vo.setTotalinsure(UFDouble.ZERO_DBL);
		        		}
		        		//若健保_始日期c入日期橥一月份且为上月(paydate的上月)->投保总额为上月分+本月份距 
		        		if((cal.get(Calendar.MONTH)+2) == vo.getPay_date().getMonth()
		        				&&enterDate.getMonth()==healthBeginDate.getMonth()){
		        			vo.setTotalinsure(lastGrade.add(thisgrade));
		        		}
		        	}
		        }
			}
		}
		return saveList;
	}

	/**
	 * 获取人员的健保级距
	 * 
	 * @return
	 * @author Ares.Tank
	 * @throws BusinessException
	 * @date 2018年9月26日 上午11:53:54
	 * @description
	 */
	private UFDouble getPsndocGrande(String pk_psndoc, UFDate payDate)
			throws BusinessException {
		UFDouble num = UFDouble.ZERO_DBL;
		// 按照日期查找人员的健保记录
		// mod 解密 2018年10月26日15:09:37
		String sqlStr = " select isnull( SALARY_DECRYPT(g2.glbdef16),0) "
				+ " from " + PsndocDefTableUtil.getPsnHealthTablename() + " g2"
				+ " where g2.pk_psndoc = '" + pk_psndoc + "' "
				+ " and g2.begindate < '" + payDate.toString()
				+ "' and isnull(g2.enddate,'9999-12-31')>'"
				+ payDate.toString() + "'  and g2.glbdef2 = '本人' ";
		List qDataList = (List) getDao().executeQuery(sqlStr,
				new ColumnListProcessor());
		for (Object numObj : qDataList) {
			
			try {
				num = new UFDouble(numObj.toString());
				return num;

			} catch (NumberFormatException e) {
				num = UFDouble.ZERO_DBL;
				Debug.error("健保信息出现脏数据,人员信息:" + pk_psndoc);
			}
		}
		return num;
	}
	/**
	 * 根据人员,薪资方案,薪资期间从薪资发放中获取'本次扣税金额'
	 * @param pk_psndoc
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @return
	 * @throws DAOException 
	 * @other payMap 薪资发放数据 map<薪资方案,map<薪资期间,map<人员,本次扣税金额>>>
	 */
	private UFDouble getPay(String pk_psndoc ,String pk_wa_class,String cyear,String cperiod) throws DAOException{
		UFDouble result = UFDouble.ZERO_DBL;
		//先从缓存中获取
		if(payMap.get(pk_wa_class)!=null&&payMap.get(pk_wa_class).get(cyear+""+cperiod)!=null){
			
			if(payMap.get(cyear+""+cperiod).get(pk_psndoc) != null){
				result = new UFDouble(payMap.get(pk_wa_class).get(cyear+""+cperiod).get(pk_psndoc));
			}
			return result;
		}
		//从薪资发放表中查出这个薪资方案和期间所有人的本次扣税金额
		String sqlStr = "select pk_psndoc ,SALARY_DECRYPT(f_4) from wa_data "
				+ " where cyear = '"+cyear+"' and cperiod = '"+cperiod
				+ "' and pk_wa_class = '"+pk_wa_class+"'";
		List<DataVO> qResult = 
				(List<DataVO>)getBaseDAO().executeQuery(sqlStr, new BeanListProcessor(DataVO.class));

		if(null == result || qResult.size() <= 0){
			//为空也存进一个map做标识
			Map<String,Map<String,Double>> map = new HashMap<>();
			map.put(cyear+""+cperiod, new HashMap<String,Double>());
			payMap.put(pk_wa_class, map);
			return result;
		}else{
			//将查询的数,缓存下次直接使用
			Map<String,Double> psnDataMap = new HashMap<>(); 
			Map<String,Map<String,Double>> datePsnMap = new HashMap<>();
			datePsnMap.put(cyear+""+cperiod,psnDataMap);
			for(DataVO dataVO : qResult){
				if(null != dataVO && null != dataVO.getPk_psndoc() 
						&& null != dataVO.getAttributeValue("f_4")){
					String value  = String.valueOf(dataVO.getAttributeValue("f_4"));
					if(value != null && !value.equals("null")){
						psnDataMap.put(dataVO.getPk_psndoc(), Double.valueOf(value));
						if(dataVO.getPk_psndoc().equals(pk_psndoc)){
							result = new UFDouble(Double.valueOf(value));
						}
					}
				}
			}
		}
		return result;
	}
	/**
	 * 结束时间String
	 * @param date
	 * @return
	 * @author Ares.Tank
	 * @date 2018年9月27日 下午6:08:23
	 * @description
	 */
	private String getEndDay(UFDate sDate) {
		//UFDate sDate = new UFDate(dateStr + "-01 00:00:00");
		if(null == sDate){
			return null;
		}
		Calendar calendar = Calendar.getInstance();
		calendar.setTime(sDate.toDate());
		calendar.set(Calendar.DAY_OF_MONTH,1);
		calendar.add(Calendar.MONTH, 1);
		UFDate date = new UFDate(calendar.getTime());
		if(date.getMonth() >=10){
			return date.getYear() + "-" + date.getMonth() + "-" + "01";
		}else{
			return date.getYear() + "-0" + date.getMonth() + "-" + "01";
		}
	}



	/**
	 * 获取这月的开始时间 string
	 * @param date
	 * @return
	 * @author Ares.Tank
	 * @date 2018年9月27日 下午6:08:20
	 * @description
	 */
	private String getStartDay(UFDate date) {
		if(null == date){
			return null;
		}
		if(date.getMonth() >=10){
			return date.getYear() + "-" + date.getMonth() + "-" + "01";
		}else{
			return date.getYear() + "-0" + date.getMonth() + "-" + "01";
		}


	}



	/*
	 * (non-Javadoc)
	 *
	 * @see nc.itf.twhr.ITwhr_declarationMaintain#writeBack4PTCost(nc.vo.twhr.
	 * twhr_declaration.AggDeclarationVO)
	 */
	@Override
	public void writeBack4PTCost(PTCostVO ptvo, String pk_org, String pk_group) throws BusinessException {
		AggDeclarationVO avo = DeclarationUtils.getAggDeclarationVO();
		avo.getParentVO().setPk_group(pk_group);
		avo.getParentVO().setPk_org(pk_org);

		// 判断申报格式
		int type = checkDeclareform(ptvo.getDeclareformat());

		// 如果是删除,则直接删除
		String tableName = null;
		if (ptvo.getStatus() == VOStatus.DELETED) {
			if(DECLAREFORM_50 == type){
				tableName = "declaration_parttime";

			}else if (DECLAREFORM_90AB == type){
				tableName = "declaration_business";

			}
			if(tableName != null){
				String sqlStr = " delete from "+tableName
						+ " where pay_date >= '"+ptvo.getPaydate().toString()+"' "
						+ " and pay_date < '"+ptvo.getPaydate().getDateAfter(1).toString()+"' "
						+ "and vbdef4 = '"+ptvo.getPk_psndoc()+"' and dr = 0 ";
				getBaseDAO().executeUpdate(sqlStr);
			}
			return ;
		}else if(ptvo.getStatus() == VOStatus.UPDATED){
			if(DECLAREFORM_50 == type){
				tableName = "declaration_parttime";

			}else if (DECLAREFORM_90AB == type){
				tableName = "declaration_business";

			}
			if(tableName != null){
				String sqlStr = " delete from "+tableName
						+ " where pay_date >= '"+ptvo.getPaydate().toString()+"' "
						+ " and pay_date < '"+ptvo.getPaydate().getDateAfter(1).toString()+"' "
						+ "and vbdef4 = '"+ptvo.getPk_psndoc()+"' and dr = 0 ";
				getBaseDAO().executeUpdate(sqlStr);
			}
		}
		// 判断是否是新生成的数据,还是同一天的数据
		SuperVO superVO = isExistPTCostRecord(ptvo.getPk_psndoc(), ptvo.getPaydate(), type);
		if (DECLAREFORM_90AB == type) {
				// 90AB格式
				SuperVO[] svos = new SuperVO[1];
				BusinessBVO newVO = null;
				// svos[0] = DeclarationUtils.getNonPartTimeBVO();
				if(null == superVO){
					 newVO = DeclarationUtils.getBusinessBVO();
				}else{
					 newVO = (BusinessBVO)(superVO.clone());
				}

				// 给付日期:
				newVO.setPay_date(new UFDate(ptvo.getPaydate().toDate()));

				Map<String, Object> baseInfo = getBaseInfo(ptvo.getPk_psndoc(), pk_org);

				// 所得人姓名
				newVO.setBeneficiary_name(baseInfo.get("beneficiary_name").toString());
				// 所得人身份证号
				newVO.setBeneficiary_id(baseInfo.get("beneficiary_id").toString());
				// 部门
				newVO.setPk_dept(null);

				// 单次给付金额
				newVO.setSingle_pay(ptvo.getTaxamount());
				// 单次扣缴补充保险费金额
				newVO.setSingle_withholding(ptvo.getExtendamount());

				// 写入薪资方案、薪资期间、法人组织 用作取消计算的标识
				newVO.setVbdef1(pk_org);
				// newVO.setVbdef2(pk_wa_class);
				// newVO.setVbdef3(pk_wa_period);
				newVO.setVbdef4(ptvo.getPk_psndoc());

				svos[0] = newVO;
				avo.setChildren(BusinessBVO.class, svos);

		}
		if (null == avo) {
			return;
		}
		AggDeclarationVO[] saveVOs = { avo };
		// 先当成新增全新的记录
		insert(saveVOs, saveVOs);
		// 根据组织查找主键,并fix
		dataFix(avo.getParentVO().getPk_org());



	}



	// 获取健保基本信息
	private Map<String, Object> getBaseInfo(String psndoc, String pk_org) throws BusinessException {
		// Map<String,Object> resultMap = new HashMap<>();
		String sqlStr = "SELECT psn.name as beneficiary_name, psn.id as beneficiary_id, "
				+ " org.glbdef40 as insurance_unit_code ,job.pk_dept as pk_dept" + "	FROM bd_psndoc psn "
				+ " left JOIN org_hrorg org on psn.pk_org = org.pk_hrorg and org.dr = 0"
				+ " left join hi_psnjob job on job.pk_psndoc = psn.pk_psndoc and lastflag = 'Y' and job.dr = 0 "
				+ " WHERE psn.pk_psndoc = '" + psndoc + "'" + " and org.pk_hrorg = '" + pk_org + "'"
				+ " and psn.dr = 0 ";
		List<Map> sqlResultMapList = (List<Map>) getBaseDAO().executeQuery(sqlStr, new MapListProcessor());
		if (null != sqlResultMapList) {

			for (Map sqlResultMap : sqlResultMapList) {
				if (null != sqlResultMap) {
					return sqlResultMap;
				}

			}

		}

		return new HashMap();
	}

	/**
	 * 判断申报格式是否为50薪资
	 * @param pk_wa_class
	 * @return 50薪资:1 90AB:2 其他:0
	 * @throws BusinessException
	 * @date 2018年9月22日 下午12:35:51
	 * @description
	 */
	private int checkDeclareform(String pk_declareform) throws BusinessException {
		if(null==pk_declareform){
			return DECLAREFORM_OTHER;
		}
		int type = 0;
		String dbCode = null;
		String sqlStr = "select code from bd_defdoc "
				+ " where bd_defdoc.pk_defdoc= '"+pk_declareform+"'";
		//判断申报格式类型
		IUAPQueryBS iUAPQueryBS = (IUAPQueryBS)NCLocator.getInstance().lookup(IUAPQueryBS.class.getName());
		List list
			= (List)iUAPQueryBS.executeQuery(sqlStr, new ColumnListProcessor());
		if (null != list && list.size() > 0) {
			for (Object obj : list) {
				if (null != obj) {
					dbCode = obj.toString();
					if(dbCode.equals("50")){
						return DECLAREFORM_50;
					}else if(dbCode.equals("9A")){
						return DECLAREFORM_90AB;
					}else if(dbCode.equals("9B")){
						return DECLAREFORM_90AB;
					}
				}
			}
		}

		return DECLAREFORM_OTHER;
	}
	/**
	 * 判断数据库中是否已经存在劳务费用的生成记录,如果有就返回主键
	 * @param psndoc 人员
	 * @param payDate 发放日
	 * @param type 申报类型  DECLAREFORM_50,DECLAREFORM_90A DECLAREFORM_90B
	 * @return
	 * @author Ares.Tank
	 * @throws BusinessException
	 * @date 2018年9月26日 下午11:51:33
	 * @description
	 */
	private SuperVO isExistPTCostRecord(String psndoc , UFLiteralDate payDate,int type) throws BusinessException{
		if(null == psndoc || null == payDate){
			return null;
		}


		String tableName;
		Class clazz = null;
		if(DECLAREFORM_50 == type){
			tableName = "declaration_parttime";
			clazz = PartTimeBVO.class;
		}else if (DECLAREFORM_90AB == type){
			tableName = "declaration_business";
			clazz = BusinessBVO.class;
		}else{
			return null;
		}
		String sqlStr = " select sub.*  from "+tableName+" sub "
				+ " where sub.pay_date >= '"+payDate.toString()+"' "
				+ " and sub.pay_date < '"+payDate.getDateAfter(1).toString()+"' "
				+ "and sub.vbdef4 = '"+psndoc+"' and sub.dr = 0 ";
		List result = (List)getBaseDAO().executeQuery(sqlStr, new BeanListProcessor(clazz));
		String pkStringRtn = null;
		if(null != result){
			for(Object obj : result){
				if(null != obj){
					return (SuperVO)obj;
				}
			}
		}
		return null;

	}

}
