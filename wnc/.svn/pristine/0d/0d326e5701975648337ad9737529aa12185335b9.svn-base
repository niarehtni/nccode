package nc.ui.overtime.otleavebalance.action;

import java.awt.Container;
import java.awt.event.ActionEvent;
import java.util.Vector;

import javax.swing.SwingUtilities;
import javax.swing.SwingWorker;

import nc.bs.framework.common.NCLocator;
import nc.bs.logging.Logger;
import nc.pubitf.para.SysInitQuery;
import nc.pubitf.ta.overtime.ISegDetailService;
import nc.ui.dcm.chnlrplstrct.maintain.action.MessageDialog;
import nc.ui.hr.caculate.view.BannerTimerDialog;
import nc.ui.hr.uif2.action.HrAction;
import nc.ui.overtime.otleavebalance.model.OTLeaveBalanceModeDataManager;
import nc.ui.overtime.otleavebalance.model.OTLeaveBalanceModel;
import nc.ui.overtime.otleavebalance.view.OTLeaveBalanceOrgPanel;
import nc.ui.pub.beans.UIRefPane;
import nc.ui.pub.bill.BillItem;
import nc.ui.uif2.editor.IBillListPanelView;
import nc.vo.pub.BusinessException;
import nc.vo.ta.overtime.OTLeaveBalanceVO;
import nc.vo.ta.timeitem.LeaveTypeCopyVO;

public class RebuildPsnSegDetailAction extends HrAction {

	/**
	 * serial no
	 */
	private static final long serialVersionUID = 6101162527113648376L;
	private IBillListPanelView listView;
	private OTLeaveBalanceOrgPanel orgpanel;
	String error = null;

	public RebuildPsnSegDetailAction() {
		setCode("REBUILDPSNSEG");
		setBtnName("重建分段");
	}

	public Container getParentContainer() {
		return SwingUtilities.getWindowAncestor(getContext().getEntranceUI());
	}

	@Override
	public void doAction(ActionEvent e) throws Exception {
		OTLeaveBalanceModel headModel = ((OTLeaveBalanceModel) this.getModel());
		OTLeaveBalanceVO otlbvo = (OTLeaveBalanceVO) headModel.getSelectedData();
		final String pk_psndoc = otlbvo.getPk_psndoc();
		BillItem billItem = this.getListView().getBillListPanel().getHeadItem("pk_psndoc");
		// 取T工Code
		UIRefPane pane = (UIRefPane) billItem.getComponent();
		Vector colval = pane.getRefModel().matchPkData(pk_psndoc);

		if (MessageDialog.showOkCancelDlg(this.getEntranceUI(), "_J", "是否重建T工 [" + ((Vector) colval.get(0)).get(0)
				+ "] 的未Y算分段Y料？") == MessageDialog.ID_OK) {
			// TODO 建\行程
			new SwingWorker<Boolean, Void>() {
				BannerTimerDialog dialog = new BannerTimerDialog(getParentContainer());

				@Override
				protected Boolean doInBackground() throws Exception {
					try {
						dialog.setStartText("正在重建分段Y料...");
						dialog.start();

						ISegDetailService svc = NCLocator.getInstance().lookup(ISegDetailService.class);
						svc.rebuildSegDetailByPsn(pk_psndoc);
					} catch (Exception e) {
						error = e.getMessage();
					} finally {
						dialog.end();
					}
					return Boolean.TRUE;
				}
			}.execute();
		}
	}

	public IBillListPanelView getListView() {
		return listView;
	}

	public void setListView(IBillListPanelView listView) {
		this.listView = listView;
	}

	protected boolean isActionEnable() {
		try {
			String pk_otleavetype = SysInitQuery.getParaString(getContext().getPk_org(), "TWHRT08");

			LeaveTypeCopyVO leaveTypeVo = (LeaveTypeCopyVO) ((OTLeaveBalanceModeDataManager) getOrgpanel()
					.getDataManager()).getHierachicalModel().getSelectedData();

			if (leaveTypeVo != null && leaveTypeVo.getPk_timeitemcopy().equals(pk_otleavetype)) {
				OTLeaveBalanceModel headModel = ((OTLeaveBalanceModel) this.getModel());
				if ((OTLeaveBalanceVO) headModel.getSelectedData() != null) {
					return true;
				}
			}
		} catch (BusinessException e) {
			Logger.error(e.getMessage());
		}

		return false;
	}

	public OTLeaveBalanceOrgPanel getOrgpanel() {
		return orgpanel;
	}

	public void setOrgpanel(OTLeaveBalanceOrgPanel orgpanel) {
		this.orgpanel = orgpanel;
	}

}
