package nc.pubimpl.wa.paydata.nhiservice;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import org.apache.commons.lang.StringUtils;

import nc.bs.dao.BaseDAO;
import nc.bs.dao.DAOException;
import nc.bs.framework.common.NCLocator;
import nc.hr.utils.InSQLCreator;
import nc.impl.wa.paydata.nhicalculate.TaiwanNHICalculator;
import nc.itf.twhr.ICalculateTWNHI;
import nc.itf.twhr.ITwhr_declarationMaintain;
import nc.itf.uap.IUAPQueryBS;
import nc.jdbc.framework.processor.ColumnListProcessor;
import nc.jdbc.framework.processor.ColumnProcessor;
import nc.jdbc.framework.processor.MapListProcessor;
import nc.jdbc.framework.processor.MapProcessor;
import nc.pub.encryption.util.SalaryEncryptionUtil;
import nc.pubitf.para.DeclarationUtils;
import nc.pubitf.para.SysInitQuery;
import nc.pubitf.para.SysInitQuery4TWHR;
import nc.pubitf.twhr.utils.LegalOrgUtilsEX;
import nc.vo.hi.psndoc.PsndocDefVO;
import nc.vo.logging.Debug;
import nc.vo.pub.BusinessException;
import nc.vo.pub.SuperVO;
import nc.vo.pub.lang.UFBoolean;
import nc.vo.pub.lang.UFDate;
import nc.vo.pub.lang.UFDouble;
import nc.vo.twhr.nhicalc.PsndocDefTableUtil;
import nc.vo.twhr.twhr_declaration.AggDeclarationVO;
import nc.vo.twhr.twhr_declaration.BusinessBVO;
import nc.vo.twhr.twhr_declaration.NonPartTimeBVO;
import nc.vo.twhr.twhr_declaration.PartTimeBVO;
import nc.vo.wa.period.PeriodVO;

public class CalculateTWNHIImpl implements ICalculateTWNHI {

	private BaseDAO dao = new BaseDAO();

	private static final String PART_TIME_PSN_MAP_KEY = "partTimePsn";

	private static final String NOT_PART_TIME_PSN_MAP_KEY = "notPartTimePsn";
	// 申报格式:50薪资:1 90AB:2 其他:0
	private static final int DECLAREFORM_50 = 1;
	private static final int DECLAREFORM_90AB = 2;
	private static final int DECLAREFORM_OTHER = 0;

	// 90A/B薪资方案扣税级距
	private static final int WA_DATA_FOR_90AB = 20000;

	@Override
	public void calculate(String pk_org, String acc_year, String acc_month)
			throws Exception {
		TaiwanNHICalculator calcBaseObj = new TaiwanNHICalculator(pk_org,
				acc_year, acc_month);

		calcBaseObj.Calculate();
	}

	@Override
	public List<Map> getNHIClassMap() throws BusinessException {
		String strSQL = "SELECT  pk_infoset , infoset_code, vo_class_name ";
		strSQL += " FROM    hr_infoset ";
		strSQL += " WHERE infoset_code IN ( select code from bd_defdoc where pk_defdoclist = (select pk_defdoclist from bd_defdoclist where code = 'TWHR000') )";
		return (List<Map>) dao.executeQuery(strSQL, new MapListProcessor());
	}

	/**
	 * 计算二代健保
	 */
	@Override
	public void updateExtendNHIInfo(String pk_group, String pk_hrorg,
			String pk_wa_class, String pk_periodscheme, String pk_wa_period,
			UFDate payDate) throws BusinessException {
		// 计算人力资源下的所有法人组织
		Set<String> legalOrgs = LegalOrgUtilsEX.getOrgsByLegal(pk_hrorg,
				pk_group);
		for (String pk_org : legalOrgs) {
			// 取劳健保启用参数
			// 当参数为否时，跳出该方法
			// ssx added for 2nd health ins on 2017-07-22
			if (null == SysInitQuery.getParaBoolean(pk_org, "TWHR01")
					|| !SysInitQuery.getParaBoolean(pk_org, "TWHR01")
							.booleanValue()) {
				continue;
			}
			// 取人T列表
			String[] pk_psndocs = getWaDataPsndocs(pk_org, pk_wa_class,
					pk_periodscheme, pk_wa_period);
			// PeriodVO pvo = (PeriodVO) dao.retrieveByPK(PeriodVO.class,
			// pk_wa_period);// 薪资期间

			// List<String> inserted_psndocs = new ArrayList<String>();
			// SimpleDocServiceTemplate service = new SimpleDocServiceTemplate(
			// "TWHRGLBDEF");
			// List<PsndocDefVO> psnLaborInfoVOs = new ArrayList<PsndocDefVO>();
			// List<String> updatedPsn = new ArrayList<String>();
			// 区分薪资方案:
			int waclassType = checkWaClass(pk_wa_class);
			if (DECLAREFORM_50 == waclassType) {
				// 50薪资
				// 区分兼职人员和非兼职人员
				Map<String, Set<String>> checkPartTimePsn = checkPartTimePsn(
						pk_psndocs, payDate);
				// 非兼职人员的计算
				if (null != checkPartTimePsn.get(NOT_PART_TIME_PSN_MAP_KEY)) {
					for (String pk_psndoc : checkPartTimePsn
							.get(NOT_PART_TIME_PSN_MAP_KEY)) {
						if (null == pk_psndoc) {
							continue;
						}
						// 找非兼人T每个人本期需要扣二代健保的薪资金额
						UFDouble curAmount = getCurrentPeriodAmount4NotPartTimePsn(
								pk_group, pk_org, pk_wa_class, pk_wa_period,
								pk_psndoc);
						// 排除不需要扣二代健保的人员
						if (needUpdateExNHI(pk_group, pk_org, pk_wa_period,
								pk_psndoc, curAmount)) {
							// updatedPsn.add(pk_psndoc);
							// 加上本期的全年累计金额
							UFDouble annaAmount = curAmount
									.add(getLastPeriodAnnualSum(pk_group,
											pk_org, pk_wa_class, payDate,
											pk_psndoc));
							// 计算非兼职人员补充保费
							UFDouble curInsAmount = getCurrentPeriodInsAmount4NotPartTimePsn(
									pk_group, pk_org, pk_wa_class,
									pk_wa_period, pk_psndoc, annaAmount,
									curAmount, payDate);
							// 非兼人T的回
							updateNotPartTimePsn(pk_group, pk_org, pk_wa_class,
									pk_wa_period, curInsAmount, pk_psndoc,
									payDate, annaAmount, curAmount);

						}
					}
				}
				// List<PsndocDefVO> laborInfo4PartTimeInfoVOs = new
				// ArrayList<PsndocDefVO>();
				// 兼职人员的计算逻辑
				if (null != checkPartTimePsn.get(PART_TIME_PSN_MAP_KEY)) {
					for (String pk_psndoc : checkPartTimePsn
							.get(PART_TIME_PSN_MAP_KEY)) {
						if (null == pk_psndoc) {
							continue;
						}
						// 找兼人T每个人本期需要扣二代健保的薪资金额
						UFDouble curAmount = getCurrentPeriodAmount4PartTimePsn(
								pk_group, pk_org, pk_wa_class, pk_wa_period,
								pk_psndoc);
						// 排除不需要扣二代健保的人员
						if (needUpdateExNHI4PartTimePsn(pk_group, pk_org,
								pk_wa_period, pk_psndoc, curAmount)) {
							// updatedPsn.add(pk_psndoc);
							// 本期补充保费金额
							UFDouble curInsAmount = getCurrentPeriodInsAmount4PartTimePsn(
									pk_group, pk_org, pk_wa_class,
									pk_wa_period, pk_psndoc, curAmount);
							// 兼人T的回
							updatePartTimePsn(pk_group, pk_org, pk_wa_class,
									pk_wa_period, curInsAmount, curAmount,
									pk_psndoc, payDate);

						}
					}
				}
			} else if (DECLAREFORM_90AB == waclassType) {
				// 90 A/B薪资
				for (String pk_psndoc : pk_psndocs) {
					if (null == pk_psndoc) {
						continue;
					}
					// 找兼人T或90A/90B每个人本期需要扣二代健保的薪资金额
					UFDouble curAmount = getCurrentPeriodAmount4PartTimePsn(
							pk_group, pk_org, pk_wa_class, pk_wa_period,
							pk_psndoc);
					// 排除不需要扣二代健保的人员
					if (needUpdateExNHI4PartTimePsn(pk_group, pk_org,
							pk_wa_period, pk_psndoc, curAmount)) {
						// updatedPsn.add(pk_psndoc);
						// 本期补充保费金额
						UFDouble curInsAmount = getCurrentPeriodInsAmountFor90AB(
								pk_group, pk_org, pk_wa_class, pk_wa_period,
								pk_psndoc, curAmount);
						// 90人T的回
						update90ABPsn(pk_group, pk_org, pk_wa_class,
								pk_wa_period, curInsAmount, curAmount,
								pk_psndoc, payDate);
					}
				}

			}

		}

	}

	/**
	 * 判断薪资方案是否为50薪资
	 * 
	 * @param pk_wa_class
	 * @return 50薪资:1 90AB:2 其他:0
	 * @throws BusinessException
	 * @date 2018年9月22日 下午12:35:51
	 * @description
	 */
	private int checkWaClass(String pk_wa_class) throws BusinessException {
		int type = 0;
		String dbCode = null;
		String sqlStr = "select code from bd_defdoc "
				+ " where bd_defdoc.pk_defdoc= ("
				+ " select declareform from WA_WACLASS where pk_wa_class='"
				+ pk_wa_class + "' )";
		// 判断薪资方案类型
		IUAPQueryBS iUAPQueryBS = (IUAPQueryBS) NCLocator.getInstance().lookup(
				IUAPQueryBS.class.getName());
		List list = (List) iUAPQueryBS.executeQuery(sqlStr,
				new ColumnListProcessor());
		if (null != list && list.size() > 0) {
			for (Object obj : list) {
				if (null != obj) {
					dbCode = obj.toString();
					if (dbCode.equals("50")) {
						return DECLAREFORM_50;
					} else if (dbCode.equals("9A")) {
						return DECLAREFORM_90AB;
					} else if (dbCode.equals("9B")) {
						return DECLAREFORM_90AB;
					}
				}
			}
		}

		return DECLAREFORM_OTHER;
	}

	/**
	 * 计算90A/B薪资方案人员的补充保费
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @param curAmount
	 *            本期勾选兼职人员薪资项目累加金额
	 * @return
	 * @throws BusinessException
	 * @date 2018年9月22日 下午12:23:58
	 * @description
	 */
	private UFDouble getCurrentPeriodInsAmountFor90AB(String pk_group,
			String pk_org, String pk_wa_class, String pk_wa_period,
			String pk_psndoc, UFDouble curAmount) throws BusinessException {
		UFDouble rtn = UFDouble.ZERO_DBL;

		if (curAmount.doubleValue() > WA_DATA_FOR_90AB) {
			UFDouble heathRate = SysInitQuery4TWHR.getParaDbl(pk_org,
					"TWEP0001");
			if (null == heathRate) {
				throw new BusinessException(
						"o法找到a充保UM率(人)O置，z查自定x(TWEP0001)的O定热荨");
			}
			rtn = rtn.multiply(heathRate).div(100);

		}
		return rtn;
	}

	/**
	 * 算兼职人员本期a充保M金~
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @param curAmount
	 *            本期兼人T需要扣除的二代健保薪Y的R
	 * @return
	 * @throws BusinessException
	 * @date 2018年9月21日 下午2:50:52
	 * @description
	 */
	private UFDouble getCurrentPeriodInsAmount4PartTimePsn(String pk_group,
			String pk_org, String pk_wa_class, String pk_wa_period,
			String pk_psndoc, UFDouble curAmount) throws BusinessException {
		UFDouble rtn = UFDouble.ZERO_DBL;
		UFDouble baseSalary = SysInitQuery4TWHR.getParaDbl(pk_org, "TWSP0009");
		if (null == baseSalary) {
			throw new BusinessException("o法找到基本工Y(月)O置，z查自定x(TWSP0009)的O定热荨");
		}
		UFDouble heathRate = SysInitQuery4TWHR.getParaDbl(pk_org, "TWEP0001");
		if (null == heathRate) {
			throw new BusinessException(
					"o法找到a充保UM率(人)O置，z查自定x(TWEP0001)的O定热荨");
		}
		if (curAmount.sub(baseSalary).doubleValue() > 0) {
			rtn = curAmount.multiply(heathRate).div(100);
		}
		return rtn;
	}

	/**
	 * 非兼人T的回
	 * 
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param curInsAmount
	 *            补充保费
	 * 
	 * @throws BusinessException
	 * @date 2018年9月21日 下午12:12:35
	 * @description 回到薪Y目上和二代健保申蠊c
	 */
	private void updateNotPartTimePsn(String pk_group, String pk_org,
			String pk_wa_class, String pk_wa_period, UFDouble curInsAmount,
			String pk_psndoc, UFDate payDate, UFDouble annaAmount,
			UFDouble curAmount) throws BusinessException {
		// List<Map> curInsAmountPSN = new ArrayList<Map>();

		// 在是否二代健保累目合不榱愕r回
		// mod 榱阋不
		if (null != curInsAmount) {
			// 查询薪Y目上a充保M目(TWEX0000规定的)
			String strSQL = "select itemkey from wa_classitem where pk_org='"
					+ pk_org
					+ "' and pk_wa_class='"
					+ pk_wa_class
					+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and pk_wa_item = (select refvalue from twhr_basedoc where pk_org='"
					+ pk_org + "' and code = 'TWEX0000' and dr=0) ";

			String itemkey = (String) dao.executeQuery(strSQL,
					new ColumnProcessor());
			// mod Ares.Tank 数据加密
			if (!StringUtils.isEmpty(itemkey)) {
				strSQL = "update wa_data set "
						+ itemkey
						+ " = "
						+ SalaryEncryptionUtil.encryption(curInsAmount
								.doubleValue()) + " where pk_org='" + pk_org
						+ "' AND pk_wa_class='" + pk_wa_class + "' "
						+ " AND cyear=(( "
						+ " SELECT cyear FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND cperiod=(( "
						+ " SELECT cperiod FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND pk_psndoc = '"
						+ pk_psndoc + "'";
				dao.executeUpdate(strSQL);
			}
			// 回写前,把该人员的,该组织的,全部薪资方案的,该期间的年度累计更新为最新的
			strSQL = "update declaration_nonparttime set totalbonusforyear = "
					+ annaAmount + " where vbdef1 = '" + pk_org
					+ "' and vbdef3 = '" + pk_wa_period + "' and vbdef4 = '"
					+ pk_psndoc + "' ";
			dao.executeUpdate(strSQL);
			ITwhr_declarationMaintain service = NCLocator.getInstance().lookup(
					ITwhr_declarationMaintain.class);
			// 回写到二代健保 '非兼`'
			AggDeclarationVO avo = DeclarationUtils.getAggDeclarationVO();
			avo.getParentVO().setPk_group(pk_group);
			avo.getParentVO().setPk_org(pk_org);

			SuperVO[] svos = new SuperVO[1];
			// svos[0] = DeclarationUtils.getNonPartTimeBVO();
			NonPartTimeBVO newVO = DeclarationUtils.getNonPartTimeBVO();
			// 给付日期:
			newVO.setPay_date(payDate);

			Map<String, Object> baseInfo = getBaseInfo(pk_psndoc, pk_org);

			// 所得人姓名
			newVO.setBeneficiary_name(null != baseInfo.get("beneficiary_name") ? baseInfo
					.get("beneficiary_name").toString() : null);
			// 所得人身份证号
			newVO.setBeneficiary_id(null != baseInfo.get("beneficiary_id") ? baseInfo
					.get("beneficiary_id").toString() : null);
			// 投保单位代号
			newVO.setInsurance_unit_code(null != baseInfo
					.get("insurance_unit_code") ? baseInfo.get(
					"insurance_unit_code").toString() : null);
			// 部门
			newVO.setPk_dept(null != baseInfo.get("pk_dept") ? baseInfo.get(
					"pk_dept").toString() : null);

			// 单次给付金额
			newVO.setSingle_pay(curAmount);
			// 单次扣缴补充保险费金额
			newVO.setSingle_withholding(curInsAmount);
			// 扣费单月投保金额(级距)
			newVO.setDeductions_month_insure(getPsndocGrande(pk_psndoc, payDate));
			// 同年度累计奖金金额
			newVO.setTotalbonusforyear(annaAmount);
			// 写入薪资方案、薪资期间、法人组织 用作取消计算的标识
			newVO.setVbdef1(pk_org);
			newVO.setVbdef2(pk_wa_class);
			newVO.setVbdef3(pk_wa_period);
			newVO.setVbdef4(pk_psndoc);

			svos[0] = newVO;
			avo.setChildren(NonPartTimeBVO.class, svos);
			service.writeBack4HealthCaculate(avo);

		}

	}

	/**
	 * 90A/B 薪资方案的回写
	 * 
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param curInsAmount
	 * @throws BusinessException
	 * @date 2018年9月22日 下午12:31:58
	 * @description
	 */
	private void update90ABPsn(String pk_group, String pk_org,
			String pk_wa_class, String pk_wa_period, UFDouble curInsAmount,
			UFDouble curAmount, String pk_psndoc, UFDate payDate)
			throws BusinessException {

		// 在是否二代健保累目合不榱愕r回
		// 小于零也要回写
		if (null != curInsAmount) {

			// 查询薪Y目上a充保M目(TWEX0000规定的)
			String strSQL = "select itemkey from wa_classitem where pk_org='"
					+ pk_org
					+ "' and pk_wa_class='"
					+ pk_wa_class
					+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and pk_wa_item = (select refvalue from twhr_basedoc where pk_org='"
					+ pk_org + "' and code = 'TWEX0000' and dr=0) ";

			String itemkey = (String) dao.executeQuery(strSQL,
					new ColumnProcessor());

			if (!StringUtils.isEmpty(itemkey)) {
				strSQL = "update wa_data set "
						+ itemkey
						+ " = "
						+ SalaryEncryptionUtil.encryption(curInsAmount
								.doubleValue()) + " where pk_org='" + pk_org
						+ "' AND pk_wa_class='" + pk_wa_class + "' "
						+ " AND cyear=(( "
						+ " SELECT cyear FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND cperiod=(( "
						+ " SELECT cperiod FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND pk_psndoc = '"
						+ pk_psndoc + "'";
				dao.executeUpdate(strSQL);
			}

			// 回写到二代健保'绦I账得'
			ITwhr_declarationMaintain service = NCLocator.getInstance().lookup(
					ITwhr_declarationMaintain.class);

			AggDeclarationVO avo = DeclarationUtils.getAggDeclarationVO();
			avo.getParentVO().setPk_group(pk_group);
			avo.getParentVO().setPk_org(pk_org);

			SuperVO[] svos = new SuperVO[1];
			// svos[0] = DeclarationUtils.getNonPartTimeBVO();
			BusinessBVO newVO = DeclarationUtils.getBusinessBVO();
			// 给付日期:
			newVO.setPay_date(payDate);

			Map<String, Object> baseInfo = getBaseInfo(pk_psndoc, pk_org);

			// 所得人姓名
			newVO.setBeneficiary_name(baseInfo.get("beneficiary_name")
					.toString());
			// 所得人身份证号
			newVO.setBeneficiary_id(baseInfo.get("beneficiary_id").toString());
			// 部门
			newVO.setPk_dept(baseInfo.get("pk_dept").toString());

			// 单次给付金额
			newVO.setSingle_pay(curAmount);
			// 单次扣缴补充保险费金额
			newVO.setSingle_withholding(curInsAmount);

			// 写入薪资方案、薪资期间、法人组织 用作取消计算的标识
			newVO.setVbdef1(pk_org);
			newVO.setVbdef2(pk_wa_class);
			newVO.setVbdef3(pk_wa_period);
			newVO.setVbdef4(pk_psndoc);

			svos[0] = newVO;
			avo.setChildren(NonPartTimeBVO.class, svos);
			service.writeBack4HealthCaculate(avo);
			/*
			 * PsndocDefVO newVO = PsndocDefUtil.getPsnNHIExtendVO();
			 * newVO.setPk_psndoc(pk_psndoc); newVO.setDr(0);
			 * newVO.setCreator("NC_USER0000000000000"); if (pvo != null) {
			 * newVO.setBegindate(pvo.getCstartdate());
			 * newVO.setEnddate(pvo.getCenddate()); } // glbdef1,薪Y期g
			 * newVO.setAttributeValue("glbdef1", pk_wa_period); // glbdef2,薪Y方案
			 * newVO.setAttributeValue("glbdef2", pk_wa_class); // glbdef3,期金~
			 * newVO.setAttributeValue("glbdef3", curAmount); // glbdef4,l放日期
			 * newVO.setAttributeValue("glbdef4", payDate); // glbdef5,年金n
			 * newVO.setAttributeValue("glbdef5", annaAmount); // glbdef6,本次a充保M
			 * newVO.setAttributeValue("glbdef6", curInsAmount); // recordnum
			 * newVO.setAttributeValue("recordnum", -1);
			 * inserted_psndocs.add(pk_psndoc); psnLaborInfoVOs.add(newVO);
			 */

		}

	}

	/**
	 * 兼人T的回
	 * 
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param curInsAmount
	 *            本期的薪Y的R金~
	 * @throws BusinessException
	 * @date 2018年9月21日 下午3:36:48
	 * @description
	 */
	private void updatePartTimePsn(String pk_group, String pk_org,
			String pk_wa_class, String pk_wa_period, UFDouble curInsAmount,
			UFDouble curAmount, String pk_psndoc, UFDate payDate)
			throws BusinessException {

		// 在是否二代健保累目合不榱愕r回
		// mod 0也回 2018年10月26日13:24:09
		if (null != curInsAmount) {

			// 查询薪Y目上a充保M目(TWEX0000规定的)
			String strSQL = "select itemkey from wa_classitem where pk_org='"
					+ pk_org
					+ "' and pk_wa_class='"
					+ pk_wa_class
					+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and pk_wa_item = (select refvalue from twhr_basedoc where pk_org='"
					+ pk_org + "' and code = 'TWEX0000' and dr=0) ";

			String itemkey = (String) dao.executeQuery(strSQL,
					new ColumnProcessor());

			if (!StringUtils.isEmpty(itemkey)) {
				strSQL = "update wa_data set "
						+ itemkey
						+ " = "
						+ SalaryEncryptionUtil.encryption(curInsAmount
								.doubleValue()) + " where pk_org='" + pk_org
						+ "' AND pk_wa_class='" + pk_wa_class + "' "
						+ " AND cyear=(( "
						+ " SELECT cyear FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND cperiod=(( "
						+ " SELECT cperiod FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND pk_psndoc = '"
						+ pk_psndoc + "'";
				dao.executeUpdate(strSQL);
			}

			ITwhr_declarationMaintain service = NCLocator.getInstance().lookup(
					ITwhr_declarationMaintain.class);

			AggDeclarationVO avo = DeclarationUtils.getAggDeclarationVO();
			avo.getParentVO().setPk_group(pk_group);
			avo.getParentVO().setPk_org(pk_org);

			SuperVO[] svos = new SuperVO[1];
			// svos[0] = DeclarationUtils.getNonPartTimeBVO();
			PartTimeBVO newVO = DeclarationUtils.getPartTimeBVO();
			// 给付日期:
			newVO.setPay_date(payDate);

			Map<String, Object> baseInfo = getBaseInfo(pk_psndoc, pk_org);

			// 所得人姓名
			newVO.setBeneficiary_name(baseInfo.get("beneficiary_name")
					.toString());
			// 所得人身份证号
			newVO.setBeneficiary_id(baseInfo.get("beneficiary_id").toString());
			// 部门
			newVO.setPk_dept(baseInfo.get("pk_dept").toString());

			// 单次给付金额
			newVO.setSingle_pay(curAmount);
			// 单次扣缴补充保险费金额
			newVO.setSingle_withholding(curInsAmount);

			// 写入薪资方案、薪资期间、法人组织 用作取消计算的标识
			newVO.setVbdef1(pk_org);
			newVO.setVbdef2(pk_wa_class);
			newVO.setVbdef3(pk_wa_period);
			newVO.setVbdef4(pk_psndoc);

			svos[0] = newVO;
			avo.setChildren(NonPartTimeBVO.class, svos);
			service.writeBack4HealthCaculate(avo);
			/*
			 * PsndocDefVO newVO = PsndocDefUtil.getPsnNHIExtendVO();
			 * newVO.setPk_psndoc(pk_psndoc); newVO.setDr(0);
			 * newVO.setCreator("NC_USER0000000000000"); if (pvo != null) {
			 * newVO.setBegindate(pvo.getCstartdate());
			 * newVO.setEnddate(pvo.getCenddate()); } // glbdef1,薪Y期g
			 * newVO.setAttributeValue("glbdef1", pk_wa_period); // glbdef2,薪Y方案
			 * newVO.setAttributeValue("glbdef2", pk_wa_class); // glbdef3,期金~
			 * newVO.setAttributeValue("glbdef3", curAmount); // glbdef4,l放日期
			 * newVO.setAttributeValue("glbdef4", payDate); // glbdef5,年金n
			 * newVO.setAttributeValue("glbdef5", annaAmount); // glbdef6,本次a充保M
			 * newVO.setAttributeValue("glbdef6", curInsAmount); // recordnum
			 * newVO.setAttributeValue("recordnum", -1);
			 * inserted_psndocs.add(pk_psndoc); psnLaborInfoVOs.add(newVO);
			 */

		}

	}

	/**
	 * 区分兼职和非兼职人员
	 * 
	 * @param pk_psndocs
	 * @return Map<psnType,Set<pk_psndoc>>
	 * @param payDate
	 * @throws BusinessException
	 * @date 2018年9月21日 上午9:56:57
	 * @description
	 */
	private Map<String, Set<String>> checkPartTimePsn(String[] pk_psndocs,
			UFDate payDate) throws BusinessException {
		Set<String> allPsndoc = new HashSet<>();// 所有人去重
		allPsndoc.addAll(Arrays.asList(pk_psndocs));

		Map<String, Set<String>> resultSetMap = new HashMap<>();
		resultSetMap.put(PART_TIME_PSN_MAP_KEY, new HashSet<String>());
		resultSetMap.put(NOT_PART_TIME_PSN_MAP_KEY, new HashSet<String>());

		InSQLCreator insql = new InSQLCreator();
		String psndocsInSQL = insql.getInSQL(pk_psndocs);

		// 取员工最新的健保记录
		String sqlStr = " select pk_psndoc,enddate " + " from "
				+ PsndocDefTableUtil.getPsnHealthTablename() + " g2"
				+ " where g2.pk_psndoc in (" + psndocsInSQL + ") "
				+ " and g2.lastflag ='Y' ";
		List<Map> mapList = (List<Map>) dao.executeQuery(sqlStr,
				new MapListProcessor());
		for (Map map : mapList) {
			if (null != map && null != map.get("pk_psndoc")) {
				if (null == map.get("enddate")
						|| map.get("enddate").equals("9999-12-31")
						|| map.get("enddate").equals(payDate)) {
					// 非兼职人员
					resultSetMap.get(NOT_PART_TIME_PSN_MAP_KEY).add(
							(String) map.get("pk_psndoc"));
					allPsndoc.remove(map.get("pk_psndoc"));
				}
			}
		}
		// 其余为兼职人员
		resultSetMap.put(PART_TIME_PSN_MAP_KEY, allPsndoc);
		return resultSetMap;
	}

	/**
	 * 不需要扣二代健保的人员
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @param curAmount
	 * @return
	 * @throws BusinessException
	 */
	private boolean needUpdateExNHI(String pk_group, String pk_org,
			String pk_wa_period, String pk_psndoc, UFDouble curAmount)
			throws BusinessException {
		boolean needs = true;
		String strSQL = "";
		// 1. 勾x「免扣a充保M」
		String fieldname = PsndocDefTableUtil.getPsnNoPayExtendNHIFieldname(
				pk_group, pk_org);
		strSQL = "select " + fieldname + " from bd_psndoc where pk_psndoc='"
				+ pk_psndoc + "'";
		String value = (String) dao.executeQuery(strSQL, new ColumnProcessor());
		if (!StringUtils.isEmpty(value)
				&& (new UFBoolean(value)).booleanValue()) {
			needs = false;
		}

		// 2. l放之薪Y年月]有健保投保距（指薪Y算的薪Y期g）
		strSQL = "select isnull(def.glbdef16, 0) healgrade  from "
				+ PsndocDefTableUtil.getPsnHealthTablename()
				+ " def"
				+ " inner join bd_psndoc psn on def.pk_psndoc = psn.pk_psndoc"
				+ " where def.pk_psndoc = '"
				+ pk_psndoc
				+ "' and (def.glbdef3 is null or def.glbdef3=psn.id)"
				+ " and begindate<=(select cenddate from wa_period where pk_wa_period='"
				+ pk_wa_period
				+ "')"
				+ " and isnull(enddate, '9999-12-31')>=(select cstartdate from wa_period where pk_wa_period='"
				+ pk_wa_period + "')" + " and def.glbdef14='Y' and def.dr=0";
		Object rtn = dao.executeQuery(strSQL, new ColumnProcessor());
		if (rtn == null || StringUtils.isEmpty(rtn.toString())
				|| rtn.toString().equals("0E-8")
				|| (Double.valueOf(rtn.toString())) == 0) {
			needs = false;
		}

		// 3. 二代健保累目0或是所l放的薪Yo二代健保目
		if (curAmount.equals(UFDouble.ZERO_DBL)) {
			needs = false;
		}

		return needs;
	}

	/**
	 * 不需要扣二代健保的人员(兼职人员用)
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @param curAmount
	 * @return
	 * @throws BusinessException
	 */
	private boolean needUpdateExNHI4PartTimePsn(String pk_group, String pk_org,
			String pk_wa_period, String pk_psndoc, UFDouble curAmount)
			throws BusinessException {
		boolean needs = true;
		String strSQL = "";
		// 1. 勾x「免扣a充保M」
		String fieldname = PsndocDefTableUtil.getPsnNoPayExtendNHIFieldname(
				pk_group, pk_org);
		strSQL = "select " + fieldname + " from bd_psndoc where pk_psndoc='"
				+ pk_psndoc + "'";
		String value = (String) dao.executeQuery(strSQL, new ColumnProcessor());
		if (!StringUtils.isEmpty(value)
				&& (new UFBoolean(value)).booleanValue()) {
			needs = false;
		}

		// 3. 二代健保累目0或是所l放的薪Yo二代健保目
		if (curAmount.equals(UFDouble.ZERO_DBL)) {
			needs = false;
		}

		return needs;
	}

	/**
	 * 得到最新一期的全年累计
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_class
	 * @param payDate
	 * @param infosetCode
	 * @param pk_psndoc
	 * @return
	 * @throws BusinessException
	 */
	private UFDouble getLastPeriodAnnualSum(String pk_group, String pk_org,
			String pk_wa_class, UFDate payDate, String pk_psndoc)
			throws BusinessException {
		UFDouble rtn = UFDouble.ZERO_DBL;
		// glbdef5 上一期的当年累计,同一月的有多薪Y方案,取最新的那
		// (其实全部都一样,回写的时候会把全部薪资方案的年度累计都置为最新的)
		String strSQL = " SELECT nonpt.totalbonusforyear "
				+ " FROM declaration_nonparttime nonpt "
				+ " left join wa_period wap on wap.pk_wa_period = nonpt.vbdef3 "
				+ " WHERE wap.cperiod = ( "
				+ " select max(wap.cperiod) from declaration_nonparttime subnonpt "
				+ " left join wa_period wap on wap.pk_wa_period = subnonpt.vbdef3 "
				+ " where wap.cyear = '" + String.valueOf(payDate.getYear())
				+ " ' and subnonpt.dr = 0 ) " + " and vbdef4 = '" + pk_psndoc
				+ "' order by nonpt.ts";
		String lastPeriodSumPSN = String.valueOf(dao.executeQuery(strSQL,
				new ColumnProcessor()));
		if (lastPeriodSumPSN != null && !lastPeriodSumPSN.equals("null")) {
			rtn = new UFDouble(lastPeriodSumPSN);
		}
		return rtn;
	}

	/**
	 * 计算非兼职人员本期的补充保费
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @param annaAmount
	 *            加上本期的全年累计金额
	 * @param curAmount
	 *            本期薪Y
	 * @return a充保M
	 * @throws BusinessException
	 * @description 用最新累的金~，c最新一P健保信息的4倍健保距比^，
	 *              若超^4倍投保金~，t⒊^後的金~c本次累e的金~比^，取小者* TWEP0001a充保UM率(人)檠a充保M
	 *              若不超过4倍的投保金额,则补充保费为0
	 */
	private UFDouble getCurrentPeriodInsAmount4NotPartTimePsn(String pk_group,
			String pk_org, String pk_wa_class, String pk_wa_period,
			String pk_psndoc, UFDouble annaAmount, UFDouble curAmount,
			UFDate payDate) throws BusinessException {
		UFDouble rtn = UFDouble.ZERO_DBL;

		UFDouble num = getPsndocGrande(pk_psndoc, payDate);
		if (null != num) {
			// 如果同年度累>=四倍投保金~
			if (annaAmount.div(4).sub(num).doubleValue() > 0) {
				// 超^4倍投保金~的
				// 超^的金~:
				UFDouble beyondNum = annaAmount.sub(num.multiply(4));
				// (使用同年度累-四倍投保金~)>=未谓o付
				if (beyondNum.doubleValue() - curAmount.doubleValue() > 0.0) {
					rtn = curAmount;
				} else {
					rtn = beyondNum;
				}
				UFDouble heathRate = SysInitQuery4TWHR.getParaDbl(pk_org,
						"TWEP0001");
				if (null == heathRate) {
					throw new BusinessException(
							"o法找到a充保UM率(人)O置，z查自定x(TWEP0001)的O定热荨");
				}
				rtn = rtn.multiply(heathRate).div(100);

			} else {
				// 不超^t0
				rtn = UFDouble.ZERO_DBL;
			}
		}

		return rtn;
	}

	/**
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @return
	 * @throws BusinessException
	 * @date 2018年9月21日 上午11:34:42
	 * @description
	 */
	private UFDouble getCurrentPeriodAmount4NotPartTimePsn(String pk_group,
			String pk_org, String pk_wa_class, String pk_wa_period,
			String pk_psndoc) throws BusinessException {
		UFDouble rtn = UFDouble.ZERO_DBL;
		List<Map> curAmountPSN = new ArrayList<Map>();
		// 找出所有勾选'二代健保累计项目'的薪资项
		String strSQL = "select itemkey from wa_classitem cls inner join twhr_waitem_30 tw on cls.pk_wa_item = tw.pk_wa_item where cls.pk_org='"
				+ pk_org
				+ "' and pk_wa_class='"
				+ pk_wa_class
				+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
				+ pk_wa_period
				+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
				+ pk_wa_period + "')) and  tw.ishealthinsexsum_30 = 'Y' ";

		List itemKeys = (List) dao.executeQuery(strSQL,
				new ColumnListProcessor());
		if (itemKeys != null && itemKeys.size() > 0) {
			strSQL = "";
			for (Object itemkey : itemKeys) {
				if (!StringUtils.isEmpty(strSQL)) {
					strSQL = strSQL + "+";
				}
				strSQL = strSQL + "isnull( SALARY_DECRYPT(" + (String) itemkey
						+ "),0)";
			}
			// 对所有的勾选项目进行累加,(选计算所有人的,下次查询缓存读取???????? 问下这个人@ssx )
			strSQL = "select ("
					+ strSQL
					+ ") curamount, pk_psndoc from wa_data where pk_org='"
					+ pk_org
					+ "' and pk_wa_class='"
					+ pk_wa_class
					+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
					+ pk_wa_period + "')) ";
			curAmountPSN = (List<Map>) dao.executeQuery(strSQL,
					new MapListProcessor());
		}

		if (curAmountPSN != null && curAmountPSN.size() > 0) {
			for (Map curAmount : curAmountPSN) {
				if (curAmount.containsKey("pk_psndoc")) {
					if (curAmount.get("pk_psndoc").equals(pk_psndoc)) {
						rtn = new UFDouble(Double.parseDouble(curAmount.get(
								"curamount").toString()));
					}
				}
			}
		}

		return rtn;
	}

	/**
	 * 用于兼职人员或90A/90B计算所有薪资项的二代健保金额
	 * 
	 * @param pk_group
	 * @param pk_org
	 * @param pk_wa_class
	 * @param pk_wa_period
	 * @param pk_psndoc
	 * @return
	 * @throws BusinessException
	 */
	private UFDouble getCurrentPeriodAmount4PartTimePsn(String pk_group,
			String pk_org, String pk_wa_class, String pk_wa_period,
			String pk_psndoc) throws BusinessException {
		UFDouble rtn = UFDouble.ZERO_DBL;
		List<Map> curAmountPSN = new ArrayList<Map>();
		String strSQL = "select itemkey from wa_classitem cls inner join twhr_waitem_30 tw on cls.pk_wa_item = tw.pk_wa_item where cls.pk_org='"
				+ pk_org
				+ "' and pk_wa_class='"
				+ pk_wa_class
				+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
				+ pk_wa_period
				+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
				+ pk_wa_period + "')) and  tw.ishealthinsparttime = 'Y' ";

		// 把@些薪Y目M行R
		List itemKeys = (List) dao.executeQuery(strSQL,
				new ColumnListProcessor());
		if (itemKeys != null && itemKeys.size() > 0) {
			strSQL = "";
			for (Object itemkey : itemKeys) {
				if (!StringUtils.isEmpty(strSQL)) {
					strSQL = strSQL + "+";
				}
				strSQL = strSQL + "isnull(" + (String) itemkey + ",0)";
			}
			strSQL = "select ("
					+ strSQL
					+ ") curamount, pk_psndoc from wa_data where pk_org='"
					+ pk_org
					+ "' and pk_wa_class='"
					+ pk_wa_class
					+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
					+ pk_wa_period + "')) ";
			curAmountPSN = (List<Map>) dao.executeQuery(strSQL,
					new MapListProcessor());
		}

		if (curAmountPSN != null && curAmountPSN.size() > 0) {
			for (Map curAmount : curAmountPSN) {
				if (curAmount.containsKey("pk_psndoc")) {
					if (curAmount.get("pk_psndoc").equals(pk_psndoc)) {
						rtn = new UFDouble(Double.parseDouble(curAmount.get(
								"curamount").toString()));
					}
				}
			}
		}

		return rtn;
	}

	/**
	 * 取指定M、薪Y方案、薪Y期g的人T列表
	 * 
	 * @param pk_org
	 *            M
	 * @param pk_wa_class
	 *            薪Y方案
	 * @param yearperiod
	 *            薪Y期g
	 * @return
	 * @throws BusinessException
	 */
	private String[] getWaDataPsndocs(String pk_org, String pk_wa_class,
			String pk_periodscheme, String pk_wa_period)
			throws BusinessException {
		String strSQL = "select cyear, cperiod from wa_period where pk_periodscheme = '"
				+ pk_periodscheme + "' and pk_wa_period='" + pk_wa_period + "'";
		Map periodRs = (Map) dao.executeQuery(strSQL, new MapProcessor());
		List<String> psndocs = null;

		if (periodRs != null && periodRs.size() > 0) {
			strSQL = "select distinct pk_psndoc from wa_data where pk_org='"
					+ pk_org + "' and pk_wa_class='" + pk_wa_class
					+ "' and cyear='" + periodRs.get("cyear")
					+ "' and cperiod='" + periodRs.get("cperiod") + "'";

			psndocs = (List<String>) dao.executeQuery(strSQL,
					new ColumnListProcessor());
		}

		if (psndocs == null || psndocs.size() == 0) {
			return null;
		} else {
			return psndocs.toArray(new String[0]);
		}
	}

	@Override
	public void deleteExtendNHIInfo(String pk_group, String pk_org,
			String pk_wa_class, String pk_periodscheme, String pk_wa_period,
			UFDate payDate) throws BusinessException {
		// 取劳健保启用参数
		// 当参数为否时，跳出该方法
		// ssx added for 2nd health ins on 2017-07-22
		if (!SysInitQuery.getParaBoolean(pk_org, "TWHR01").booleanValue()) {
			return;
		}

		// 取二代健保子集O置
		String infosetCode = PsndocDefTableUtil.getPsnHealthInsExTablename(
				pk_group, pk_org);

		if (StringUtils.isEmpty(infosetCode)) {
			throw new BusinessException("o法找到二代健保子集O置，z查自定x(TWHR000)的O定热荨");
		}

		// 取人T列表
		String[] pk_psndocs = getWaDataPsndocs(pk_org, pk_wa_class,
				pk_periodscheme, pk_wa_period);

		// 检查是否有更新的资料，如有则不允许取消发放
		checkNewRecord(pk_wa_class, pk_wa_period, infosetCode, pk_psndocs);

		String strSQL = "";
		for (String pk_psndoc : pk_psndocs) {
			strSQL = "delete from " + infosetCode + " where glbdef1='"
					+ pk_wa_period + "' and glbdef2='" + pk_wa_class
					// + "' and glbdef4='" + payDate.toString();
					// 同一期间，同一方案，只能出现一条，所以不需要按发放日期清理
					+ "' and pk_psndoc='" + pk_psndoc + "'";
			dao.executeUpdate(strSQL);
		}

		for (String pk_psndoc : pk_psndocs) {
			strSQL = "update " + infosetCode
					+ " set recordnum=recordnum-1 where pk_psndoc='"
					+ pk_psndoc + "'";
			dao.executeUpdate(strSQL);
		}

		updateLastFlag(infosetCode, pk_psndocs);
	}

	private void checkNewRecord(String pk_wa_class, String pk_wa_period,
			String infosetCode, String[] pk_psndocs) throws DAOException,
			BusinessException {
		String strSQL = "";
		// 检查是否有更新的资料，如有则不允许取消发放
		for (String pk_psndoc : pk_psndocs) {
			strSQL = "select * from " + infosetCode + " where pk_psndoc='"
					+ pk_psndoc + "' and glbdef1='" + pk_wa_period
					+ "' and glbdef2='" + pk_wa_class + "' and lastflag='N'";
			Map rst = (Map) dao.executeQuery(strSQL, new MapProcessor());

			if (rst != null && rst.size() > 0) {
				throw new BusinessException("此方案K非二代健保Y料最新一P，o法M行撤N。");
			}
		}
	}

	private void updateLastFlag(String infosetCode, String[] pk_psndocs)
			throws BusinessException {
		String strSQL = "";
		for (String pk_psndoc : pk_psndocs) {
			strSQL = "update "
					+ infosetCode
					+ " set recordnum = (select rowno from (select pk_psndoc_sub, (select count(*) from "
					+ infosetCode
					+ " where pk_psndoc=def.pk_psndoc group by pk_psndoc)-(row_number() over (partition BY def.pk_psndoc ORDER BY def.begindate, def.enddate)) rowno from  "
					+ infosetCode + " def where def.pk_psndoc=" + infosetCode
					+ ".pk_psndoc) TMP where pk_psndoc_sub=" + infosetCode
					+ ".pk_psndoc_sub) where pk_psndoc = '" + pk_psndoc + "'";
			dao.executeUpdate(strSQL);

			strSQL = "update "
					+ infosetCode
					+ " set lastflag = case when recordnum = (select MIN(recordnum) from "
					+ infosetCode
					+ " def where "
					+ infosetCode
					+ ".pk_psndoc = def.pk_psndoc) then 'Y' else 'N' end where pk_psndoc = '"
					+ pk_psndoc + "'";
			dao.executeUpdate(strSQL);
		}

	}

	/**
	 * 获取人员的健保级距
	 * 
	 * @return
	 * @author Ares.Tank
	 * @throws BusinessException
	 * @date 2018年9月26日 上午11:53:54
	 * @description
	 */
	private UFDouble getPsndocGrande(String pk_psndoc, UFDate payDate)
			throws BusinessException {
		// 按照日期查找人员的健保记录
		// mod 解密 2018年10月26日15:09:37
		String sqlStr = " select isnull( SALARY_DECRYPT(g2.glbdef16),0) "
				+ " from " + PsndocDefTableUtil.getPsnHealthTablename() + " g2"
				+ " where g2.pk_psndoc = '" + pk_psndoc + "' "
				+ " and g2.begindate < '" + payDate.toString()
				+ "' and isnull(g2.enddate,'9999-12-31')>'"
				+ payDate.toString() + "'  and g2.glbdef2 = '本人' ";
		List qDataList = (List) dao.executeQuery(sqlStr,
				new ColumnListProcessor());
		for (Object numObj : qDataList) {
			UFDouble num;
			try {
				num = new UFDouble(numObj.toString());
				return num;

			} catch (NumberFormatException e) {
				num = UFDouble.ZERO_DBL;
				Debug.error("健保信息出现脏数据,人员信息:" + pk_psndoc);

			}
		}
		return null;
	}

	// 获取健保基本信息
	private Map<String, Object> getBaseInfo(String psndoc, String pk_org)
			throws BusinessException {
		// Map<String,Object> resultMap = new HashMap<>();
		String sqlStr = "SELECT psn.name as beneficiary_name, psn.id as beneficiary_id, "
				+ " org.glbdef40 as insurance_unit_code ,job.pk_dept as pk_dept"
				+ "	FROM bd_psndoc psn "
				+ " left JOIN org_hrorg org on psn.pk_org = org.pk_hrorg "
				+ " left join hi_psnjob job on job.pk_psndoc = psn.pk_psndoc and lastflag = 'Y' "
				+ " WHERE psn.pk_psndoc = '"
				+ psndoc
				+ "'"
				+ " and org.pk_hrorg = '"
				+ pk_org
				+ "'"
				+ " and psn.dr = 0 and org.dr = 0 and job.dr = 0 ";
		List<Map> sqlResultMapList = (List<Map>) dao.executeQuery(sqlStr,
				new MapListProcessor());
		if (null != sqlResultMapList) {

			for (Map sqlResultMap : sqlResultMapList) {
				if (null != sqlResultMap) {
					return sqlResultMap;
				}

			}

		}

		return new HashMap();
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see nc.itf.twhr.ICalculateTWNHI#delExtendNHIInfo(java.lang.String)
	 */
	@Override
	public void delExtendNHIInfo(String pk_group, String pk_orgs,
			String pk_wa_class, String pk_wa_period) throws BusinessException {
		// 删除子表和主表的信息
		// 计算人力资源下的所有法人组织
		Set<String> legalOrgs = LegalOrgUtilsEX.getOrgsByLegal(pk_orgs,
				pk_group);
		for (String pk_org : legalOrgs) {
			// 取消时,先把这月比这笔薪资方案后发放的方案的年度累计金额减去本次的金额

			// 回写前,把该人员的,该组织的,全部薪资方案的,该期间的年度累计更新为最新的
			String sqlStr = " update declaration_nonparttime main "
					+ " set main.totalbonusforyear = (main.totalbonusforyear-sub.single_pay) "
					+ " left join (select vbdef4,single_pay from declaration_nonparttime where  vbdef1 = '"
					+ pk_org + "' and vbdef2 = '" + pk_wa_class
					+ "' and vbdef3 = '" + pk_wa_period + "') sub "
					+ " on sub.vbdef4 = main.vbdef4 "
					+ " where  main.vbdef1 = '" + pk_org
					+ "' and main.vbdef3 ='" + pk_wa_period + "'";
			try {
				dao.executeUpdate(sqlStr);
			} catch (BusinessException e) {
				Debug.debug(e.getMessage());
			}
			sqlStr = "delete from  declaration_business " + " where vbdef1 = '"
					+ pk_org + "'" + " and vbdef2 = '" + pk_wa_class + "'"
					+ " and vbdef3 = '" + pk_wa_period + "' and dr = 0";

			try {
				dao.executeUpdate(sqlStr);
			} catch (BusinessException e) {
				Debug.debug(e.getMessage());
			}

			sqlStr = "delete from  declaration_nonparttime "
					+ " where vbdef1 = '" + pk_org + "'" + " and vbdef2 = '"
					+ pk_wa_class + "'" + " and vbdef3 = '" + pk_wa_period
					+ "' and dr = 0";

			try {
				dao.executeUpdate(sqlStr);
			} catch (BusinessException e) {
				Debug.debug(e.getMessage());

			}

			sqlStr = "delete from  declaration_parttime " + " where vbdef1 = '"
					+ pk_org + "'" + " and vbdef2 = '" + pk_wa_class + "'"
					+ " and vbdef3 = '" + pk_wa_period + "' and dr = 0";

			try {
				dao.executeUpdate(sqlStr);
			} catch (BusinessException e) {
				Debug.debug(e.getMessage());

			}

			sqlStr = "delete from  declaration_company " + " where vbdef1 = '"
					+ pk_org + "'" + " and vbdef2 = '" + pk_wa_class + "'"
					+ " and vbdef3 = '" + pk_wa_period + "' and dr = 0";

			try {
				dao.executeUpdate(sqlStr);
			} catch (BusinessException e) {
				Debug.debug(e.getMessage());
			}

			// 置空二代健保的薪资项
			// 查询薪Y目上a充保M目(TWEX0000规定的)
			String strSQL = "select itemkey from wa_classitem where pk_org='"
					+ pk_org
					+ "' and pk_wa_class='"
					+ pk_wa_class
					+ "' and cyear=((select cyear from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and cperiod=((select cperiod from wa_period where pk_wa_period='"
					+ pk_wa_period
					+ "')) and pk_wa_item = (select refvalue from twhr_basedoc where pk_org='"
					+ pk_org + "' and code = 'TWEX0000' and dr=0) ";

			String itemkey = (String) dao.executeQuery(strSQL,
					new ColumnProcessor());

			if (!StringUtils.isEmpty(itemkey)) {
				strSQL = "update wa_data set " + itemkey + " = 0"
						+ " where pk_org='" + pk_org + "' AND pk_wa_class='"
						+ pk_wa_class + "' " + " AND cyear=(( "
						+ " SELECT cyear FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "'))" + " AND cperiod=(( "
						+ " SELECT cperiod FROM wa_period WHERE pk_wa_period='"
						+ pk_wa_period + "')) ";
				dao.executeUpdate(strSQL);
			}

		}
	}

}
