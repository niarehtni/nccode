package nc.pubimpl.ta.leaveextrarest;

import nc.bs.dao.BaseDAO;
import nc.hr.utils.InSQLCreator;
import nc.pubitf.ta.leaveextrarest.ILeaveExtraRestService;
import nc.vo.pub.BusinessException;
import nc.vo.pub.lang.UFLiteralDate;
import nc.vo.ta.leaveextrarest.LeaveExtraRestVO;

import org.apache.commons.lang.StringUtils;

public class LeaveExtraRestServiceImpl implements ILeaveExtraRestService {

	private BaseDAO baseDao = null;

	public BaseDAO getBaseDao() {
		if (baseDao == null) {
			baseDao = new BaseDAO();
		}
		return baseDao;
	}

	@Override
	public void settledByExpiryDate(String pk_org, String[] pk_psndocs, UFLiteralDate settleDate, Boolean isForce)
			throws BusinessException {
		String strCondition = " dr=0 and isnull(issettled,'~')='~' ";

		if (isForce) {
			// 如果制Y算，必指定人T列表，不允S整M制Y算
			if (pk_psndocs == null || pk_psndocs.length == 0) {
				throw new BusinessException("制Y算e`：未指定Y算人T。");
			}
		} else {
			// 非制Y算r，Y算日期不能榭
			if (settleDate == null) {
				throw new BusinessException("Y算e`：Y算日期不能榭铡");
			}

			strCondition += " and expiredate='" + settleDate.toString() + "' ";
		}

		// 以人橄龋褐付ㄈT的，按指定人TM行Y算，否t按整MM行Y算
		if (pk_psndocs == null || pk_psndocs.length == 0) {
			if (StringUtils.isEmpty(pk_org)) {
				throw new BusinessException("Y算e`：Y算M和Y算人T不能同r榭铡");
			}

			strCondition += " and pk_org = '" + pk_org + "'";
		} else {
			InSQLCreator insql = new InSQLCreator();
			strCondition += " and pk_psndoc in (" + insql.getInSQL(pk_psndocs) + ")";
		}

		this.getBaseDao().executeUpdate(
				"update " + LeaveExtraRestVO.getDefaultTableName() + " set issettled='Y' where " + strCondition);

	}

}
