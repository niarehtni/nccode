package nc.impl.ta.algorithm;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import nc.bs.dao.BaseDAO;
import nc.bs.framework.common.NCLocator;
import nc.itf.ta.IPsnCalendarQueryService;
import nc.itf.ta.algorithm.IDateScope;
import nc.itf.ta.algorithm.impl.DefaultDateScope;
import nc.pubitf.para.SysInitQuery;
import nc.vo.bd.shift.ShiftVO;
import nc.vo.hi.psndoc.PsndocVO;
import nc.vo.pub.BusinessException;
import nc.vo.pub.lang.UFLiteralDate;
import nc.vo.ta.psncalendar.AggPsnCalendar;
import nc.vo.ta.psncalendar.PsnCalendarVO;

import org.apache.commons.lang.StringUtils;

public abstract class AbstractTWHolidayOffdayValidator implements ITWHolidayOffdayValidate {
	private IPsnCalendarQueryService calendarService;
	private BaseDAO baseDAO;

	public void validate(String pk_org, String pk_psndoc, UFLiteralDate checkDate) throws BusinessException {
		IDateScope[] checkScope = this.getDateScopeGroupContainsCheckDate(pk_org, checkDate);
		Map<UFLiteralDate, Integer> allDayTypeMap = new HashMap<UFLiteralDate, Integer>();

		checkScope = this.reGroupDateScope(checkScope, this.getMinHolidayCheckWeeks());
		for (IDateScope scope : checkScope) {
			Map<UFLiteralDate, Integer> dayTypeMap = new HashMap<UFLiteralDate, Integer>();

			AggPsnCalendar[] vos = this.getCalendarService().queryCalendarVOsByPsnDates(pk_org, pk_psndoc,
					scope.getBegindate(), scope.getEnddate());

			for (AggPsnCalendar vo : vos) {
				int dayType = -1;
				if (((PsnCalendarVO) vo.getParentVO()).getDate_daytype() == null) {
					String pk_shift = ((PsnCalendarVO) vo.getParentVO()).getPk_shift();
					if (pk_shift == null) {
						return;
					} else {
						if (pk_shift.equals(ShiftVO.PK_GX)) {
							dayType = 1;
						} else {
							dayType = 0;
						}
					}
				} else {
					dayType = ((PsnCalendarVO) vo.getParentVO()).getDate_daytype();
				}
				dayTypeMap.put(vo.getDate(), dayType);
				allDayTypeMap.put(vo.getDate(), dayType);
			}

			// 排班日小於z查L期要求日，即槲赐瓿膳虐啵不M行校
			if (dayTypeMap.size() < this.getMinHolidayCheckWeeks() * 7) {
				return;
			}

			try {
				// 7休1之例假日校
				this.checkHoliday(dayTypeMap, new int[] { 4 }, this.getHolidayCountInMinCheckWeeks());
			} catch (BusinessException e) {
				PsndocVO psnvo = (PsndocVO) this.getBaseDAO().retrieveByPK(PsndocVO.class, pk_psndoc);
				throw new BusinessException(e.getMessage() + "\r\nT工：" + psnvo.getCode() + "\r\nL期：["
						+ scope.getBegindate().toString() + "] ~ [" + scope.getEnddate().toString() + "]\r\n");
			}
		}

		// 排班日小於z查L期要求日，即槲赐瓿膳虐啵不M行校
		if (allDayTypeMap.size() < getCheckedWeeks() * 7) {
			return;
		}
		try {
			// 例假日及休假日盗啃ｒ
			this.checkHoliday(allDayTypeMap, new int[] { 1, 4 }, this.getTotalHolidaysAndOffdaysCount());
		} catch (BusinessException e) {
			PsndocVO psnvo = (PsndocVO) this.getBaseDAO().retrieveByPK(PsndocVO.class, pk_psndoc);
			throw new BusinessException(e.getMessage() + "\r\nT工：" + psnvo.getCode() + "\r\nL期：["
					+ checkScope[0].getBegindate().toString() + "] ~ ["
					+ checkScope[checkScope.length - 1].getEnddate().toString() + "]\r\n");
		}
	}

	/**
	 * z查L
	 * 
	 * @return
	 * @throws BusinessException
	 */
	public abstract int getCheckedWeeks() throws BusinessException;

	/**
	 * 最小例假z查L
	 * 
	 * @return
	 * @throws BusinessException
	 */
	public abstract int getMinHolidayCheckWeeks() throws BusinessException;

	/**
	 * 最小例假z查L含有例假日的天
	 * 
	 * @return
	 * @throws BusinessException
	 */
	public abstract int getHolidayCountInMinCheckWeeks() throws BusinessException;

	public abstract int getTotalHolidaysAndOffdaysCount() throws BusinessException;

	/**
	 * 根M和z查日期取z查L期
	 * 
	 * @param pk_org
	 *            MPK
	 * @param checkDate
	 *            z查日期
	 * @return
	 * @throws BusinessException
	 */
	public IDateScope[] getDateScopeGroupContainsCheckDate(String pk_org, UFLiteralDate checkDate)
			throws BusinessException {
		// 根M等∫焕一休z查_始日期
		UFLiteralDate startDate = getOrgStartDate(pk_org);

		// z查日c起始日相差天
		int days = UFLiteralDate.getDaysBetween(startDate, checkDate);
		// z查日c起始日相差L期
		int passedWeeks = (int) Math.floor(Double.valueOf(days) / Double.valueOf(getCheckedWeeks() * 7));

		UFLiteralDate startCheckDate = startDate.getDateAfter(passedWeeks * 7);

		List<DefaultDateScope> scopes = new ArrayList<DefaultDateScope>();
		for (int i = 0; i < getCheckedWeeks(); i++) {
			DefaultDateScope scope = new DefaultDateScope();
			scope.setBegindate(startCheckDate.getDateAfter(i * 7));
			scope.setEnddate(scope.getBegindate().getDateAfter(6));
			scopes.add(scope);
		}
		return scopes.toArray(new IDateScope[0]);
	}

	/**
	 * 根最小z查L芜L重新分M
	 * 
	 * @param oneWeekScopes
	 *            芜L到M
	 * @param groupWeeks
	 *            分ML
	 * @return
	 * @throws BusinessException
	 */
	public IDateScope[] reGroupDateScope(IDateScope[] oneWeekScopes, int groupWeeks) throws BusinessException {
		if (groupWeeks == 1) {
			return oneWeekScopes;
		} else {
			int i = 1;
			DefaultDateScope newScope = null;
			List<DefaultDateScope> reGroupedScope = new ArrayList<DefaultDateScope>();
			for (IDateScope scope : oneWeekScopes) {
				if (i == 1) {
					newScope = new DefaultDateScope();
					newScope.setBegindate(scope.getBegindate());
				} else if (i == this.getMinHolidayCheckWeeks()) {
					newScope.setEnddate(scope.getEnddate());
					reGroupedScope.add(newScope);
					i = 0;
				}
				i++;
			}
			return reGroupedScope.toArray(new IDateScope[0]);
		}
	}

	private UFLiteralDate getOrgStartDate(String pk_org) throws BusinessException {
		String strStart = SysInitQuery.getParaString(pk_org, "TWHRT01");
		UFLiteralDate startDate = null;
		if (!StringUtils.isEmpty(strStart)) {
			startDate = new UFLiteralDate(strStart);
		}

		if (startDate == null) {
			throw new BusinessException("一例一休校失。何粗付ㄒ焕一休起始更日（TWHRT01）");
		}

		// 翟O定的_始日期是星期
		int weekDayOfStartDate = startDate.getWeek();
		// 翟O定的周起算日是星期
		int startWeekDay = SysInitQuery.getParaInt(pk_org, "TWHRT02");

		// 如果_始日期在L不是L起算日定的星期祝要查找下一星期鬃z查的L期起算天
		if (weekDayOfStartDate != startWeekDay) {
			startDate = startDate.getDateAfter(weekDayOfStartDate < startWeekDay ? (startWeekDay - weekDayOfStartDate)
					: (7 + startWeekDay - weekDayOfStartDate));
		}
		return startDate;
	}

	public void checkHoliday(Map<UFLiteralDate, Integer> dayTypeMap, int[] checkDateTypes, int minCount)
			throws BusinessException {
		int matched = 0;
		for (Entry<UFLiteralDate, Integer> dayType : dayTypeMap.entrySet()) {
			for (int checkType : checkDateTypes) {
				if (checkType == dayType.getValue()) {
					matched++;
				}
			}
		}

		if (checkDateTypes.length == 1) {
			if (matched < minCount) {
				throw new BusinessException("例假日天档挽诨法定。");
			}
		} else {
			if (matched < minCount) {
				throw new BusinessException("例假日及休息日天档挽诨法定");
			}
		}
	}

	public IPsnCalendarQueryService getCalendarService() {
		if (calendarService == null) {
			calendarService = NCLocator.getInstance().lookup(IPsnCalendarQueryService.class);
		}
		return calendarService;
	}

	public BaseDAO getBaseDAO() {
		if (baseDAO == null) {
			baseDAO = new BaseDAO();
		}

		return baseDAO;
	}
}
